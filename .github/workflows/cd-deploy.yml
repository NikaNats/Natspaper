name: Production Deployment

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

on:
  push:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: production
  cancel-in-progress: false

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm run lint
      - run: pnpm run format:check
      - run: pnpm astro check

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:run

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      
      - run: pnpm install --frozen-lockfile
      
      # Cache Playwright browsers before install
      - name: Cache Playwright
        id: cache-pw
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}
      
      # Only install if cache miss
      - name: Install Playwright
        if: steps.cache-pw.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium
      
      - run: pnpm exec playwright test --project chromium
        env:
          SITE_WEBSITE: https://natspaper.vercel.app

  deploy:
    name: Deploy
    needs: [quality, test, e2e]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://natspaper.vercel.app
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      
      - run: pnpm add -g vercel
      - run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      - run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Get build size
        id: size
        run: |
          size_kb=$(du -sk .vercel/output | cut -f1)
          size_mb=$(awk "BEGIN {printf \"%.1f\", $size_kb/1024}")
          echo "mb=$size_mb" >> $GITHUB_OUTPUT
          
          # Find largest files
          echo "### ðŸ“¦ Build: ${size_mb}MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          find .vercel/output -type f -exec du -h {} + 2>/dev/null | 
            sort -rh | head -5 | 
            awk '{printf "- %s - `%s`\n", $1, $2}' >> $GITHUB_STEP_SUMMARY
      
      - run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Summary
        run: |
          echo "### âœ… Deployed to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ steps.size.outputs.mb }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY

  verify:
    name: Verify
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Check deployment
        run: |
          url="https://natspaper.vercel.app"
          
          for page in "/" "/posts" "/tags" "/archives" "/search"; do
            status=$(curl -sL -w "%{http_code}" -o /dev/null "$url$page")
            if [ "$status" = "200" ]; then
              echo "âœ… $page"
            else
              echo "âŒ $page returned $status"
              exit 1
            fi
          done
          
          echo "### âœ… All pages verified" >> $GITHUB_STEP_SUMMARY
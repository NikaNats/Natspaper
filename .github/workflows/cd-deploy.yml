name: Production Deployment

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

on:
  push:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: production
  cancel-in-progress: false

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile --prefer-offline
      - run: pnpm run lint
      - run: pnpm run format:check

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile --prefer-offline
      - run: pnpm test:run

  build:
    name: Build
    needs: [quality, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      # SECURITY FIX: Use env var instead of --token flag
      - run: npx vercel --cwd . pull --yes --environment=production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      # SECURITY FIX: Use env var instead of --token flag
      - run: npx vercel --cwd . build --prod
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Get build size
        id: size
        run: |
          size_kb=$(du -sk .vercel/output | cut -f1)
          size_mb=$(awk "BEGIN {printf \"%.1f\", $size_kb/1024}")
          echo "mb=$size_mb" >> $GITHUB_OUTPUT

          # Find largest files
          echo "### ðŸ“¦ Build: ${size_mb}MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          find .vercel/output -type f -exec du -h {} + 2>/dev/null | 
            sort -rh | head -5 | 
            awk '{printf "- %s - `%s`\n", $1, $2}' >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: vercel-build
          path: .vercel/output
          retention-days: 1

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://natspaper.vercel.app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: vercel-build
          path: .vercel/output

      - name: Get build size
        id: size
        run: |
          size_kb=$(du -sk .vercel/output | cut -f1)
          size_mb=$(awk "BEGIN {printf \"%.1f\", $size_kb/1024}")
          echo "mb=$size_mb" >> $GITHUB_OUTPUT

          # Find largest files
          echo "### ðŸ“¦ Build: ${size_mb}MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          find .vercel/output -type f -exec du -h {} + 2>/dev/null | 
            sort -rh | head -5 | 
            awk '{printf "- %s - `%s`\n", $1, $2}' >> $GITHUB_STEP_SUMMARY

      # SECURITY FIX: Use env var instead of --token flag
      - name: Deploy to Production
        id: deploy
        run: |
          url=$(npx vercel --cwd . deploy --prebuilt --prod)
          echo "url=$url" >> $GITHUB_OUTPUT
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Summary
        run: |
          echo "### âœ… Deployed to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- URL: ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ steps.size.outputs.mb }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY

      - name: Performance metrics
        run: |
          echo "### ðŸ“Š Build Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Node modules: $(du -sh node_modules | cut -f1)" >> $GITHUB_STEP_SUMMARY

          # Warn on size increases
          if [ "${{ steps.size.outputs.mb }}" -gt 50 ]; then
            echo "âš ï¸ Build size exceeds 50MB" >> $GITHUB_STEP_SUMMARY
          fi

  verify:
    name: Verify
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Check deployment
        run: |
          BASE_URL="https://natspaper.vercel.app/en"

          echo "ðŸ” Running health checks for $BASE_URL..."

          for page in "/" "/posts" "/tags" "/archives" "/search"; do
            status=$(curl -s -L -w "%{http_code}" -o /dev/null "$BASE_URL$page")
            if [ "$status" = "200" ]; then
              echo "âœ… $page"
            else
              echo "âŒ $page returned $status"
              exit 1
            fi
          done

          echo ""
          echo "### âœ… All pages verified" >> $GITHUB_STEP_SUMMARY

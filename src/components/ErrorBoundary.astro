---
// REFACTORED: This component now becomes a client-side island.
// Its entire purpose is interactive, so we make it a client component.
---

<div id="error-boundary-wrapper">
  <!-- 1. The "Try" Block: This is where your normal content goes. -->
  <div id="error-boundary-content">
    <slot />
  </div>

  <!-- 2. The "Catch" Block: This is the fallback UI, hidden by default. -->
  <div id="error-boundary-fallback" class="hidden">
    <div class="error-message">
      <h2 class="text-2xl font-bold">Something went wrong</h2>
      <p class="mt-2">
        We're sorry for the inconvenience. The error has been reported to our
        team.
      </p>
      <button
        id="error-boundary-reload-btn"
        class="mt-4 rounded bg-red-700 px-4 py-2 text-white transition-colors hover:bg-red-800"
      >
        Reload page
      </button>
    </div>
  </div>
</div>

<!-- 3. All styles are now scoped and use Tailwind's @apply for consistency. -->
<style>
  .error-message {
    padding: 2rem;
    margin: 1rem 0;
    border: 1px solid #ff6b6b;
    border-radius: 0.5rem;
    background-color: #ffe0e0;
    color: #c92a2a;
  }
</style>

<script>
  // REFACTORED: The script is now simple, focused, and declarative.
  function initErrorBoundary() {
    const wrapper = document.getElementById("error-boundary-wrapper");
    // Early exit if this script has already run for this component
    if (!wrapper || wrapper.dataset.initialized) return;

    const contentEl = document.getElementById("error-boundary-content");
    const fallbackEl = document.getElementById("error-boundary-fallback");
    const reloadBtn = document.getElementById("error-boundary-reload-btn");

    if (!contentEl || !fallbackEl || !reloadBtn) return;

    // The central error handling logic
    const handleError = (error: unknown, context: string) => {
      // eslint-disable-next-line no-console
      console.error(`[ErrorBoundary/${context}]`, error);

      // Sentry reporting logic remains the same, but simplified
      type GlobalWithSentry = typeof globalThis & {
        __SENTRY__?: {
          captureException?: (
            error: unknown,
            options?: Record<string, unknown>
          ) => void;
        };
      };

      const sentry = (window as GlobalWithSentry).__SENTRY__;
      if (sentry?.captureException) {
        sentry.captureException(error, {
          tags: { component: "ErrorBoundary", context },
          contexts: {
            error: {
              message: error instanceof Error ? error.message : String(error),
            },
          },
        });
      }

      // Declarative UI toggle: hide content, show fallback
      contentEl.hidden = true;
      fallbackEl.classList.remove("hidden");
    };

    // Attach global listeners for unhandled errors and promise rejections
    window.addEventListener("error", event =>
      handleError(event.error, "window.error")
    );
    window.addEventListener("unhandledrejection", event =>
      handleError(event.reason, "unhandledrejection")
    );

    // Attach event listener for the reload button
    reloadBtn.addEventListener("click", () => {
      window.location.reload();
    });

    // Mark as initialized to prevent re-attaching listeners on page transitions
    wrapper.dataset.initialized = "true";
  }

  // Run on initial load and after Astro's view transitions
  initErrorBoundary();
  document.addEventListener("astro:page-load", initErrorBoundary);
</script>

---
// src/components/Search.astro
import { SITE } from "@/config";

export interface Props {
  locale: "en" | "ka";
}

const { locale } = Astro.props;

const backUrl = SITE.showBackButton ? `/${locale}/search` : `/${locale}/`;
---

<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
<script src="/pagefind/pagefind-ui.js" is:inline></script>

<div
  id="search"
  transition:persist
  data-backurl={backUrl}
  data-locale={locale}
  style="visibility: hidden;"
>
</div>

<script is:inline>
  let searchInstance = null;

  function initSearch() {
    const searchEl = document.querySelector("#search");
    if (!searchEl) return;

    // Your existing cleanup logic is perfect.
    if (searchInstance && typeof searchInstance.destroy === "function") {
      searchInstance.destroy();
      searchInstance = null;
    }
    const existingUI = searchEl.querySelector(".pagefind-ui");
    if (existingUI) {
      existingUI.remove();
    }

    const locale =
      searchEl.getAttribute("data-locale") ||
      document.documentElement.lang ||
      "en";

    // Create the Pagefind UI instance
    searchInstance = new window.PagefindUI({
      element: "#search",
      showSubResults: true,
      showImages: false,
      translations: {
        placeholder:
          locale === "ka" ? "მოძებნე სტატიები..." : "Search articles...",
      },
    });

    // Make the initialized component visible
    searchEl.style.visibility = "visible";
  }

  // THE FIX: Use 'astro:page-load' which runs on initial load AND after every navigation.
  // This single event listener replaces the need for DOMContentLoaded and astro:after-swap.
  document.addEventListener("astro:page-load", initSearch, { once: true });
</script>

<style is:global>
  /* Your styles remain unchanged */
  #search {
    --pagefind-ui-font: var(--font-mono);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-tag: var(--background);
    --pagefind-ui-border-radius: 0.375rem;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;
  }

  #search form::before {
    background-color: var(--foreground);
  }

  #search input {
    font-weight: 400;
    border: 1px solid var(--border);
  }

  #search input:focus-visible {
    outline: 1px solid var(--accent);
  }

  #search .pagefind-ui__result-title a {
    color: var(--accent);
    outline-offset: 1px;
    outline-color: var(--accent);
  }

  #search .pagefind-ui__result-title a:focus-visible,
  #search .pagefind-ui__search-clear:focus-visible {
    text-decoration-line: none;
    outline-width: 2px;
    outline-style: dashed;
  }

  #search .pagefind-ui__result:last-of-type {
    border-bottom: 0;
  }

  #search .pagefind-ui__result-nested .pagefind-ui__result-link:before {
    font-family: system-ui;
  }
</style>
---
/**
 * Analytics Component - GDPR/CCPA Compliant
 *
 * Uses Vercel Web Analytics which is privacy-compliant by design:
 * - NO cookies used
 * - NO personal data collected
 * - Data is aggregated and anonymized
 * - No consent banner required
 *
 * @see https://vercel.com/docs/analytics/privacy-and-compliance
 *
 * NOTE: Vercel Web Analytics is enabled via @astrojs/vercel adapter in astro.config.ts
 * (webAnalytics: { enabled: true }). We only import SpeedInsights here since the
 * adapter doesn't include it automatically.
 *
 * Features:
 * - User opt-out via localStorage ('va-disable')
 * - Sensitive URL filtering
 * - Development mode detection
 * - Cost optimization (localhost filtering)
 */
import SpeedInsights from "@vercel/speed-insights/astro";

const isDev = import.meta.env.DEV;
---

<!--
  ============================================================
  VERCEL ANALYTICS & SPEED INSIGHTS CONFIGURATION
  ============================================================

  GDPR/CCPA COMPLIANCE:
  - Vercel Analytics is privacy-compliant by design
  - No cookies, no personal identifiers
  - No consent banner required
  - Users can opt-out via localStorage

  COST OPTIMIZATION (Hobby Tier: 50k events/month):
  1. Ignore localhost events
  2. Filter out sensitive/private routes
  3. Allow user opt-out

  @see https://vercel.com/docs/analytics/privacy-and-compliance
  @see https://vercel.com/docs/analytics/redacting-sensitive-data
-->
<script is:inline>
  // WEB ANALYTICS: Privacy-first with user opt-out
  window.webAnalyticsBeforeSend = function (event) {
    // 1. RESPECT USER OPT-OUT
    // Users can set localStorage.setItem('va-disable', 'true') to opt out
    try {
      if (localStorage.getItem("va-disable") === "true") {
        return null;
      }
    } catch {
      // localStorage may be unavailable (private browsing)
    }

    // 2. IGNORE LOCALHOST (save quota for production)
    const hostname = window.location.hostname;
    if (hostname === "localhost" || hostname === "127.0.0.1") {
      return null;
    }

    // 3. FILTER SENSITIVE ROUTES
    const url = event.url || "";
    if (
      url.includes("/private") ||
      url.includes("/drafts") ||
      url.includes("/admin") ||
      url.includes("/api/")
    ) {
      return null;
    }

    // 4. REDACT SENSITIVE QUERY PARAMETERS
    try {
      const urlObj = new URL(event.url, window.location.origin);
      const sensitiveParams = ["token", "secret", "key", "password", "email"];
      sensitiveParams.forEach(function (param) {
        if (urlObj.searchParams.has(param)) {
          urlObj.searchParams.set(param, "[REDACTED]");
        }
      });
      // IMPORTANT: Keep full URL (Vercel API requires https:// prefix)
      event.url = urlObj.href;
    } catch {
      // URL parsing failed, use original
    }

    return event;
  };

  // SPEED INSIGHTS: Same privacy rules
  window.speedInsightsBeforeSend = function (data) {
    // 1. Respect user opt-out
    try {
      if (localStorage.getItem("va-disable") === "true") {
        return null;
      }
    } catch {
      // localStorage unavailable
    }

    // 2. Ignore localhost
    const hostname = window.location.hostname;
    if (hostname === "localhost" || hostname === "127.0.0.1") {
      return null;
    }

    return data;
  };
</script>

<!--
  SpeedInsights Component
  - sampleRate: 1.0 = 100% of users.
    ⚠️ If you exceed 10k views/month, lower this to 0.5 or 0.1
    to stay within free tier limits.
  
  NOTE: Vercel Web Analytics is already enabled via @astrojs/vercel adapter
  in astro.config.ts, so we don't need to include VercelAnalytics component here.
-->
<SpeedInsights debug={isDev} sampleRate={1.0} />

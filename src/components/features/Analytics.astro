---
/**
 * Analytics Component - GDPR/CCPA Compliant
 *
 * Uses Vercel Web Analytics which is privacy-compliant by design:
 * - NO cookies used
 * - NO personal data collected
 * - Data is aggregated and anonymized
 * - No consent banner required
 *
 * @see https://vercel.com/docs/analytics/privacy-and-compliance
 *
 * NOTE: Vercel Web Analytics is enabled via @astrojs/vercel adapter in astro.config.ts
 * (webAnalytics: { enabled: true }). We only import SpeedInsights here since the
 * adapter doesn't include it automatically.
 *
 * Features:
 * - User opt-out via localStorage ('va-disable')
 * - Sensitive URL filtering
 * - Development mode detection
 * - Cost optimization (localhost filtering)
 */
const isDev = import.meta.env.DEV;
---

<!--
  ============================================================
  VERCEL ANALYTICS & SPEED INSIGHTS CONFIGURATION
  ============================================================

  GDPR/CCPA COMPLIANCE:
  - Vercel Analytics is privacy-compliant by design
  - No cookies, no personal identifiers
  - No consent banner required
  - Users can opt-out via localStorage

  COST OPTIMIZATION (Hobby Tier: 50k events/month):
  1. Ignore localhost events
  2. Filter out sensitive/private routes
  3. Allow user opt-out

  @see https://vercel.com/docs/analytics/privacy-and-compliance
  @see https://vercel.com/docs/analytics/redacting-sensitive-data
-->
<script is:inline>
  // WEB ANALYTICS: Privacy-first with user opt-out
  window.webAnalyticsBeforeSend = function (event) {
    // 1. RESPECT USER OPT-OUT
    // Users can set localStorage.setItem('va-disable', 'true') to opt out
    try {
      if (localStorage.getItem("va-disable") === "true") {
        return null;
      }
    } catch {
      // localStorage may be unavailable (private browsing)
    }

    // 2. IGNORE LOCALHOST (save quota for production)
    const hostname = window.location.hostname;
    if (hostname === "localhost" || hostname === "127.0.0.1") {
      return null;
    }

    // 3. FILTER SENSITIVE ROUTES
    const url = event.url || "";
    if (
      url.includes("/private") ||
      url.includes("/drafts") ||
      url.includes("/admin") ||
      url.includes("/api/")
    ) {
      return null;
    }

    // 4. REDACT SENSITIVE QUERY PARAMETERS
    try {
      const urlObj = new URL(event.url, window.location.origin);
      const sensitiveParams = ["token", "secret", "key", "password", "email"];
      sensitiveParams.forEach(function (param) {
        if (urlObj.searchParams.has(param)) {
          urlObj.searchParams.set(param, "[REDACTED]");
        }
      });
      // IMPORTANT: Keep full URL (Vercel API requires https:// prefix)
      event.url = urlObj.href;
    } catch {
      // URL parsing failed, use original
    }

    return event;
  };

  // SPEED INSIGHTS: Same privacy rules
  window.speedInsightsBeforeSend = function (data) {
    // 1. Respect user opt-out
    try {
      if (localStorage.getItem("va-disable") === "true") {
        return null;
      }
    } catch {
      // localStorage unavailable
    }

    // 2. Ignore localhost
    const hostname = window.location.hostname;
    if (hostname === "localhost" || hostname === "127.0.0.1") {
      return null;
    }

    return data;
  };
</script>

<!--
  Speed Insights — guarded manual injection.

  WHY: @vercel/speed-insights/astro re-registers an `astro:page-load` handler
  every time this component is rendered.  With Astro View Transitions the body
  is swapped on every navigation, so the handler count grows unboundedly and
  every blocked-by-ad-blocker error is logged once per accumulated handler.

  FIX:
  1. A `window.__siInit` guard ensures the <script> tag is appended exactly once.
  2. `onerror` is a no-op — ad blockers routinely block telemetry endpoints and
     the error is expected / non-actionable for end users.
  3. A single, idempotent `astro:page-load` listener (also guarded) nudges the
     already-loaded SDK to report each soft-navigation as a new page view.

  NOTE: Vercel Web Analytics is already enabled via @astrojs/vercel adapter
  in astro.config.ts, so we don't need a separate VercelAnalytics component.
-->
<script is:inline define:vars={{ isDev }}>
  (function () {
    // ── Guard: run the bootstrap logic only once per browser session ──────────
    if (window.__siInit) return;
    window.__siInit = true;

    // ── Inject the Speed Insights loader script ───────────────────────────────
    const s = document.createElement("script");
    s.src = "/_vercel/speed-insights/script.js";
    s.async = true;
    s.defer = true;
    if (isDev) s.setAttribute("data-debug", "true");
    // Silently swallow blocked-by-ad-blocker / net errors — these are
    // expected when the user has an ad blocker enabled and are not actionable.
    s.onerror = function () {};
    document.head.appendChild(s);

    // ── Re-report on Astro View Transition page loads ─────────────────────────
    // After the script loads, window.si (the Speed Insights API) becomes
    // available.  On each soft-navigation we ask it to flush pending vitals.
    document.addEventListener("astro:page-load", function () {
      // `window.si` is the Speed Insights push function injected by the script.
      if (typeof window.si === "function") {
        window.si("event", { name: "Astro View Transition" });
      }
    });
  })();
</script>

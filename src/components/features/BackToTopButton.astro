---
import IconChevronLeft from "@/assets/icons/IconChevronLeft.svg";
import IconArrowNarrowUp from "@/assets/icons/IconArrowNarrowUp.svg";
import { SITE } from "@/config"; // Import configuration
---

<div
  id="btt-btn-container"
  data-threshold={SITE.backToTopThreshold}
  data-visible="false"
  class:list={[
    "transition-opacity-transform fixed end-4 bottom-8 z-50 duration-500",
    "md:sticky md:end-auto md:float-end md:me-1",
  ]}
>
  <button
    data-button="back-to-top"
    class:list={[
      "group relative bg-background px-2 py-1",
      "size-14 rounded-full shadow-xl",
      "md:h-8 md:w-fit md:rounded-md md:shadow-none md:focus-visible:rounded-none",
      "md:bg-background/35 md:bg-clip-padding md:backdrop-blur-lg",
    ]}
  >
    <span
      id="progress-indicator"
      class="absolute inset-0 -z-10 block size-14 scale-110 rounded-full bg-transparent md:hidden md:h-8 md:rounded-md"
    ></span>
    <IconChevronLeft class="inline-block rotate-90 md:hidden" />
    <span class="sr-only text-sm group-hover:text-accent md:not-sr-only">
      <IconArrowNarrowUp class="inline-block size-4" />
      Back To Top
    </span>
  </button>
</div>

{/* NEW: Component-scoped styles for visibility */}
<style>
  #btt-btn-container {
    opacity: 0;
    transform: translateY(3.5rem); /* Equivalent to translate-y-14 */
  }
  #btt-btn-container[data-visible="true"] {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script is:inline data-astro-rerun>
  function initBackToTop() {
    // REFACTORED: Get threshold from data attribute (sourced from config)

    // REFACTORED: Scope all queries to this component instance
    const container = document.getElementById("btt-btn-container");
    if (!container || container.dataset.initialized) return; // Early exit if not found or already initialized

    const button = container.querySelector("[data-button='back-to-top']");
    const progressIndicator = container.querySelector("#progress-indicator");
    const VISIBILITY_THRESHOLD = parseFloat(
      container.dataset.threshold || "0.3"
    );

    // NEW: Use modern, smooth scrolling API
    button.addEventListener("click", () => {
      window.scrollTo({
        top: 0,
        behavior: "smooth", // Provides a much nicer user experience
      });
    });

    const handleScroll = () => {
      const { scrollTop, scrollHeight, clientHeight } =
        document.documentElement;
      const scrollTotal = scrollHeight - clientHeight;

      // Prevent division by zero on pages with no scroll
      if (scrollTotal <= 0) {
        container.dataset.visible = "false";
        return;
      }

      const scrollPercent = (scrollTop / scrollTotal) * 100;

      // REFACTORED: Simplified style update
      progressIndicator.style.backgroundImage = `conic-gradient(var(--accent) ${scrollPercent}%, transparent ${scrollPercent}%)`;

      // REFACTORED: Declarative state change
      const isVisible = scrollTop / scrollTotal > VISIBILITY_THRESHOLD;
      container.dataset.visible = isVisible.toString();
    };

    // Performance: Use requestAnimationFrame for smooth scroll handling
    let ticking = false;
    document.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Mark as initialized to prevent re-attaching listeners on page transitions
    container.dataset.initialized = "true";
  }

  // Ensure script runs on initial load and after Astro's view transitions
  initBackToTop();
  document.addEventListener("astro:page-load", initBackToTop);
</script>

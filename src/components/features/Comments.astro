---
import { GISCUS } from "@/config";

export interface Props {
  locale?: string;
}

const isEnabled =
  GISCUS.enabled && !!GISCUS.repo && !!GISCUS.repoId && !!GISCUS.categoryId;

const { locale = "en" } = Astro.props;
---

{
  isEnabled && (
    <div class="giscus-wrapper">
      <div class="giscus" />

      <script
        is:inline
        data-astro-rerun
        src="https://giscus.app/client.js"
        data-repo={GISCUS.repo}
        data-repo-id={GISCUS.repoId}
        data-category={GISCUS.category}
        data-category-id={GISCUS.categoryId}
        data-mapping={GISCUS.mapping}
        data-strict="0"
        data-reactions-enabled={GISCUS.reactionsEnabled ? "1" : "0"}
        data-emit-metadata={GISCUS.emitMetadata ? "1" : "0"}
        data-input-position={GISCUS.inputPosition}
        data-theme="transparent_dark"
        data-lang={locale}
        data-loading={GISCUS.loading}
        crossorigin="anonymous"
        async
      />
    </div>
  )
}

<script is:inline>
  /**
   * Helper to determine the correct theme URL.
   * 1. Detects Localhost (Giscus cannot load CSS from localhost, so we fallback).
   * 2. Adds a timestamp (?v=...) to force Giscus to purge its cache of your CSS.
   */
  function getThemeUrl(theme) {
    const origin = window.location.origin;

    // Fallback for development
    if (origin.includes("localhost") || origin.includes("127.0.0.1")) {
      return theme === "dark" ? "noborder_gray" : "noborder_light";
    }

    // Production: Use custom CSS with cache buster
    const cacheBuster = `?v=${Date.now()}`;
    return theme === "dark"
      ? `${origin}/styles/giscus-dark.css${cacheBuster}`
      : `${origin}/styles/giscus-light.css${cacheBuster}`;
  }

  function updateGiscusTheme() {
    const theme = document.documentElement.dataset.theme || "light";
    const giscusTheme = getThemeUrl(theme);

    const iframe = document.querySelector("iframe.giscus-frame");
    if (!iframe) return;

    iframe.contentWindow.postMessage(
      { giscus: { setConfig: { theme: giscusTheme } } },
      "https://giscus.app"
    );
  }

  // --- Event Handling (Prevent Memory Leaks) ---
  if (window.handleGiscusThemeChange) {
    document.removeEventListener(
      "theme-changed",
      window.handleGiscusThemeChange
    );
  }

  window.handleGiscusThemeChange = updateGiscusTheme;
  document.addEventListener("theme-changed", window.handleGiscusThemeChange);

  // --- Initialization Logic ---
  const giscusContainer = document.querySelector(".giscus");
  if (giscusContainer) {
    const observer = new MutationObserver(mutations => {
      mutations.forEach(mutation => {
        if (
          mutation.addedNodes.length > 0 &&
          mutation.addedNodes[0].tagName === "IFRAME" &&
          mutation.addedNodes[0].classList.contains("giscus-frame")
        ) {
          updateGiscusTheme();
          observer.disconnect();
        }
      });
    });
    observer.observe(giscusContainer, { childList: true });
  }
</script>

<style>
  .giscus-wrapper {
    width: 100%;
    margin-top: 2rem;
  }
  .giscus-wrapper :global(.giscus-frame) {
    width: 100%;
  }
</style>

---
/**
 * ThemeManager Component
 * ======================
 * Handles dark/light mode with FOUC (Flash of Unstyled Content) prevention.
 *
 * ## Architecture Decision: Why Inline Scripts?
 *
 * We use `is:inline` scripts for theme detection because:
 * 1. **Bundled scripts are deferred** - They execute after the DOM is painted,
 *    which causes a visible flash when the theme doesn't match the default.
 * 2. **Inline scripts execute synchronously** - They run before first paint,
 *    allowing us to set the `data-theme` attribute before any styles are applied.
 *
 * ## How It Works:
 *
 * 1. `color-scheme: light dark` - Tells the browser to respect OS-level preferences
 *    for form controls, scrollbars, and other native elements.
 *
 * 2. **Instant theme detection** (inline script):
 *    - Checks localStorage for saved preference (user has toggled before)
 *    - Falls back to `prefers-color-scheme` media query (OS preference)
 *    - Sets `data-theme` attribute on `<html>` BEFORE first paint
 *
 * 3. **Theme toggle button** (deferred external script):
 *    - Loaded from `/public/toggle-theme.js`
 *    - Handles user interaction with the theme toggle
 *    - Persists choice to localStorage
 *
 * ## CSS Integration:
 *
 * The theme is consumed via CSS custom properties in `global.css`:
 * ```css
 * html[data-theme="dark"] {
 *   --background: #121212;
 *   --foreground: #e0e0e0;
 * }
 * ```
 *
 * @see /public/toggle-theme.js - Theme toggle button logic
 * @see src/styles/global.css - Theme color definitions
 */
---

<meta name="theme-color" content="" />

<!-- Critical inline styles to prevent FOUC -->
<style is:inline>
  html {
    color-scheme: light dark;
  }
</style>

<!--
  GRACEFUL DEGRADATION: Fallback styles when JavaScript is disabled.
  Uses prefers-color-scheme to respect OS theme preference.
  The site remains fully usable without JS - only the theme toggle button won't work.
-->
<noscript>
  <style>
    /* When JS is disabled, use system preference directly */
    @media (prefers-color-scheme: dark) {
      html {
        --background: #121212;
        --foreground: #e0e0e0;
        --accent: #6aadff;
        --muted: #1e1e1e;
        --border: #333333;
        --text-secondary: #b3b3b3;
        --code-bg: #2a2a2a;
      }
      html[data-theme] {
        /* Force dark theme variables */
        --background: #121212 !important;
        --foreground: #e0e0e0 !important;
      }
    }
    /* Hide the theme toggle button since it won't work without JS */
    #theme-btn {
      display: none !important;
    }
  </style>
</noscript>

<!--
  CRITICAL: This script MUST be inline to prevent FOUC.
  It runs synchronously before first paint.
  DO NOT convert to a bundled script.
-->
<script is:inline>
  (function () {
    // First, check if user has a saved theme preference
    let theme;
    if (typeof localStorage !== "undefined") {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme) {
        theme = savedTheme;
      } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        theme = "dark";
      } else {
        theme = "light";
      }
    } else {
      // Fallback if localStorage is unavailable
      theme = window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light";
    }

    // Apply theme immediately to prevent flash
    document.documentElement.dataset.theme = theme;
    window.initialTheme = theme;
  })();
</script>

<!-- Deferred script for the theme toggle button -->
<script is:inline defer src="/toggle-theme.js"></script>

---
import type { CollectionEntry } from "astro:content";
import type { HTMLAttributes } from "astro/types";
import { slugifyStr } from "@/utils/core";
import { getReadingTimeDisplay } from "@/utils/post";
import Datetime from "./Datetime.astro";
import ReadingTime from "./ReadingTime.astro";

export interface Props extends HTMLAttributes<"li"> {
  href: string;
  frontmatter: CollectionEntry<"blog">["data"];
  body?: string;
}

const { href, frontmatter, body = "", class: className, ...rest } = Astro.props;

const {
  title,
  description,
  pubDatetime,
  modDatetime,
  timezone,
  tags = [],
} = frontmatter;

// KISS & Performance: Avoid expensive split operations. Check existence or let util handle it.
const readingTimeText = body ? getReadingTimeDisplay(body) : undefined;

// Logic: Pre-calculate tag data to keep template clean
const MAX_TAGS = 2;
const visibleTags = tags.slice(0, MAX_TAGS);
const hiddenTagsCount = tags.length - MAX_TAGS;

// Styles: Extracted common transition classes for DRY
const transitionClasses = "transition-all duration-300 ease-in-out";
---

<li
  class:list={["featured-post-item", className]}
  data-testid="post-card"
  {...rest}
>
  <a
    href={href}
    class="group block focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent focus-visible:outline-dashed"
    aria-label={`Read featured post: ${title}`}
  >
    <article
      class:list={[
        "relative rounded-lg border-2 border-accent/30 p-6",
        "bg-linear-to-br from-muted/50 via-background to-background",
        "group-hover:border-accent/60 group-hover:shadow-lg group-hover:shadow-accent/10",
        transitionClasses,
      ]}
    >
      <!-- Decorative Corner -->
      <div
        class:list={[
          "absolute top-0 right-0 h-16 w-16 rounded-bl-lg bg-accent/5 opacity-0",
          "group-hover:opacity-100",
          transitionClasses,
        ]}
        aria-hidden="true"
      >
      </div>

      <!-- Badge -->
      <div
        class="mb-3 inline-flex items-center gap-1 rounded-full bg-accent/10 px-3 py-1 text-xs font-semibold text-accent"
      >
        <span aria-hidden="true">‚≠ê</span>
        <span>Featured</span>
      </div>

      <!-- Title -->
      <h3
        class="text-xl font-bold text-foreground transition-colors duration-200 group-hover:text-accent"
        style={{ viewTransitionName: slugifyStr(title) }}
      >
        {title}
      </h3>

      <!-- Metadata -->
      <div
        class="mt-4 flex flex-wrap items-center gap-4 text-sm text-text-secondary"
      >
        <Datetime {pubDatetime} {modDatetime} {timezone} />
        {readingTimeText && <ReadingTime text={readingTimeText} size="sm" />}
      </div>

      <!-- Excerpt -->
      <p class="mt-4 line-clamp-3 leading-relaxed text-foreground">
        {description}
      </p>

      <!-- Tags -->
      {
        visibleTags.length > 0 && (
          <div class="mt-4 flex flex-wrap items-center gap-2">
            {visibleTags.map((tag: string) => (
              <span class="rounded-full bg-accent/10 px-2.5 py-1 text-xs font-medium text-accent transition-colors group-hover:bg-accent/20">
                #{tag}
              </span>
            ))}
            {hiddenTagsCount > 0 && (
              <span class="text-xs text-text-secondary">
                +{hiddenTagsCount}
              </span>
            )}
          </div>
        )
      }
    </article>
  </a>
</li>

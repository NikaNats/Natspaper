---
// src/components/post/MobileTableOfContents.astro
// Mobile-optimized, collapsible Table of Contents using native <details> element
// Lightweight, performant, and requires minimal JavaScript

import type { MarkdownHeading } from "astro";
import IconChevronRight from "@/assets/icons/IconChevronRight.svg";

export interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;
// Filter headings (h2 and h3 only)
const toc = headings.filter(h => h.depth >= 2 && h.depth <= 3);
---

{
  toc.length > 0 && (
    <div class="mb-8 lg:hidden">
      <details class="group rounded-xl border border-border/60 bg-muted/30 transition-colors open:bg-muted/50">
        <summary class="flex cursor-pointer list-none items-center justify-between p-4 font-medium text-foreground transition-colors duration-200 hover:bg-muted/60 focus-visible:ring-2 focus-visible:ring-accent focus-visible:outline-none">
          <span class="text-sm font-bold tracking-wide uppercase opacity-80">
            Table of Contents
          </span>
          <IconChevronRight class="size-5 text-text-secondary transition-transform duration-300 group-open:rotate-90" />
        </summary>

        <nav
          class="border-t border-border/40 px-4 pt-2 pb-4"
          aria-label="Mobile Table of Contents"
        >
          <ul class="flex flex-col gap-2">
            {toc.map(heading => (
              <li class:list={[{ "pl-4": heading.depth === 3 }]}>
                <a
                  href={`#${heading.slug}`}
                  class="block rounded px-2 py-1 text-sm text-text-secondary no-underline transition-colors hover:text-accent focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-1 active:text-accent"
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </details>
    </div>
  )
}

<script>
  /**
   * Auto-close mobile TOC when a link is clicked
   * Improves UX by automatically returning focus to content
   */
  function initMobileTOC() {
    const detailsElements = document.querySelectorAll(
      "div.lg\\:hidden > details"
    );

    detailsElements.forEach(details => {
      details.addEventListener("click", e => {
        // If a link inside the details was clicked, close it
        if ((e.target as HTMLElement).closest("a")) {
          // Use setTimeout to ensure the navigation happens first
          setTimeout(() => {
            details.removeAttribute("open");
          }, 0);
        }
      });
    });
  }

  // Run on initial page load and after View Transitions
  document.addEventListener("astro:page-load", initMobileTOC);
</script>

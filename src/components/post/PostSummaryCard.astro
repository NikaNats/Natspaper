---
/**
 * Fluid Post Summary Card Component
 * ==================================
 * A fully responsive, accessible post card with elastic scaling.
 *
 * Features:
 * - CSS Container Queries for true component-level responsiveness
 * - Fluid typography using clamp() for smooth scaling
 * - Elastic spacing that scales proportionally
 * - Optimized hover/focus states with reduced motion support
 * - Semantic HTML with proper heading hierarchy
 * - Accessible: proper focus states, ARIA labels
 * - i18n: All UI strings are translated
 *
 * @example
 * <PostSummaryCard
 *   title="My Post"
 *   description="A brief description..."
 *   pubDatetime={new Date()}
 *   slug="my-post"
 * />
 */
import { slugifyStr } from "@/utils/core";
import { calculateReadingTimeFromWords, formatReadingTime } from "@/utils/post";
import Datetime from "./Datetime.astro";
import ReadingTime from "./ReadingTime.astro";
import { getI18n, type Lang } from "@/i18n";

export interface Props {
  title: string;
  description: string;
  pubDatetime: Date;
  modDatetime?: Date | null;
  timezone?: string;
  slug: string;
  variant?: "h2" | "h3";
  wordCount?: number;
  tags?: string[];
  featured?: boolean;
}

const {
  title,
  description,
  pubDatetime,
  modDatetime,
  timezone,
  slug,
  variant = "h2",
  wordCount = 0,
  tags = [],
  featured = false,
} = Astro.props;

// Get translations for current locale
const { t } = getI18n(Astro.currentLocale as Lang);

// Polymorphic Heading for semantic flexibility
const Heading = variant;

// Computed values
const href = `/${Astro.currentLocale}/posts/${slug}`;
const readingTime =
  wordCount > 0
    ? formatReadingTime(calculateReadingTimeFromWords(wordCount))
    : null;

// Limit visible tags for clean UI
const MAX_TAGS = 3;
const visibleTags = tags.slice(0, MAX_TAGS);
const hiddenTagsCount = tags.length - MAX_TAGS;
---

<li class="post-card" data-testid="post-card">
  <a {href} class="post-card__link" aria-label={`Read post: ${title}`}>
    <article
      class:list={[
        "post-card__article",
        { "post-card__article--featured": featured },
      ]}
    >
      {/* Featured Badge */}
      {
        featured && (
          <div class="post-card__badge">
            <span aria-hidden="true">✨</span>
            <span>{t("post.featured")}</span>
          </div>
        )
      }

      {/* Title */}
      <Heading
        class="post-card__title"
        style={{ viewTransitionName: slugifyStr(title) }}
      >
        {title}
      </Heading>

      {/* Metadata Row */}
      <div class="post-card__meta">
        <Datetime {pubDatetime} {modDatetime} {timezone} />
        {readingTime && <ReadingTime text={readingTime} size="sm" />}
      </div>

      {/* Description */}
      <p class="post-card__description">
        {description}
      </p>

      {/* Tags */}
      {
        visibleTags.length > 0 && (
          <div class="post-card__tags" role="list" aria-label="Post tags">
            {visibleTags.map(tag => (
              <span class="post-card__tag" role="listitem">
                #{tag}
              </span>
            ))}
            {hiddenTagsCount > 0 && (
              <span class="post-card__tag-overflow">+{hiddenTagsCount}</span>
            )}
          </div>
        )
      }
    </article>
  </a>
</li>

<style>
  /* ==========================================================================
     POST SUMMARY CARD - Fluid Responsive Design
     ==========================================================================
     Uses modern CSS features for true elasticity:
     - Container queries for component-level breakpoints
     - Fluid typography with clamp()
     - Logical properties for RTL support
     - Custom properties for theming
     ========================================================================== */

  .post-card {
    /* Container query context */
    container-type: inline-size;
    container-name: post-card;

    /* Reset list styling */
    list-style: none;
  }

  .post-card__link {
    display: block;
    text-decoration: none;
    outline: none;
    border-radius: 0.75rem;

    /* Focus state */
    &:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
  }

  .post-card__article {
    /* Fluid padding - scales 320px → 1280px */
    --card-padding: clamp(1rem, 0.75rem + 1vw, 1.5rem);

    position: relative;
    padding: var(--card-padding);
    border-radius: 0.75rem;
    border: 1px solid color-mix(in srgb, var(--color-border) 40%, transparent);
    background: color-mix(in srgb, var(--color-muted) 30%, transparent);

    /* Smooth transitions */
    transition:
      border-color 0.2s ease,
      background-color 0.2s ease,
      box-shadow 0.2s ease,
      transform 0.2s ease;
  }

  /* Hover & Focus States */
  .post-card__link:hover .post-card__article,
  .post-card__link:focus-visible .post-card__article {
    border-color: color-mix(in srgb, var(--color-accent) 40%, transparent);
    background: color-mix(in srgb, var(--color-muted) 50%, transparent);
    box-shadow: 0 4px 12px -4px
      color-mix(in srgb, var(--color-accent) 15%, transparent);
  }

  /* Subtle lift on hover */
  .post-card__link:hover .post-card__article {
    transform: translateY(-2px);
  }

  @media (prefers-reduced-motion: reduce) {
    .post-card__link:hover .post-card__article {
      transform: none;
    }
  }

  /* Featured variant */
  .post-card__article--featured {
    border-left: 4px solid var(--color-accent);
    background: color-mix(in srgb, var(--color-muted) 20%, transparent);
  }

  /* Featured Badge */
  .post-card__badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-block-end: 0.5rem;
    padding: 0.125rem 0.625rem;
    border-radius: 9999px;
    background: color-mix(in srgb, var(--color-accent) 10%, transparent);
    font-size: clamp(0.6875rem, 0.625rem + 0.125vw, 0.75rem);
    font-weight: 600;
    color: var(--color-accent);
  }

  /* Title - Fluid typography */
  .post-card__title {
    /* Fluid: 1.0625rem → 1.25rem */
    font-size: clamp(1.0625rem, 1rem + 0.25vw, 1.25rem);
    font-weight: 700;
    line-height: 1.3;
    color: var(--color-foreground);
    margin: 0;
    transition: color 0.2s ease;
  }

  .post-card__link:hover .post-card__title,
  .post-card__link:focus-visible .post-card__title {
    color: var(--color-accent);
  }

  /* Metadata Row */
  .post-card__meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: clamp(0.5rem, 0.375rem + 0.5vw, 1rem);
    margin-block-start: clamp(0.5rem, 0.375rem + 0.25vw, 0.75rem);
    font-size: clamp(0.8125rem, 0.75rem + 0.125vw, 0.875rem);
    color: var(--color-text-secondary);
  }

  /* Description - Fluid typography */
  .post-card__description {
    /* Fluid: 0.9375rem → 1rem */
    font-size: clamp(0.9375rem, 0.875rem + 0.125vw, 1rem);
    line-height: 1.6;
    color: var(--color-foreground);
    margin-block-start: clamp(0.5rem, 0.375rem + 0.25vw, 0.75rem);
    margin-block-end: 0;

    /* Limit to 3 lines */
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Tags Container */
  .post-card__tags {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: clamp(0.375rem, 0.25rem + 0.25vw, 0.5rem);
    margin-block-start: clamp(0.75rem, 0.5rem + 0.5vw, 1rem);
  }

  /* Individual Tag */
  .post-card__tag {
    padding: clamp(0.1875rem, 0.125rem + 0.125vw, 0.25rem)
      clamp(0.5rem, 0.375rem + 0.25vw, 0.625rem);
    border-radius: 9999px;
    background: var(--color-muted);
    font-size: clamp(0.6875rem, 0.625rem + 0.125vw, 0.75rem);
    font-weight: 500;
    color: var(--color-text-secondary);
    transition:
      background-color 0.2s ease,
      color 0.2s ease;
  }

  .post-card__link:hover .post-card__tag,
  .post-card__link:focus-visible .post-card__tag {
    background: color-mix(in srgb, var(--color-accent) 10%, transparent);
    color: var(--color-accent);
  }

  .post-card__tag-overflow {
    font-size: clamp(0.6875rem, 0.625rem + 0.125vw, 0.75rem);
    color: var(--color-text-secondary);
  }

  /* ==========================================================================
     CONTAINER QUERIES - Component-level Responsiveness
     ==========================================================================
     Adjust layout based on the card's container width, not viewport.
     ========================================================================== */

  /* Narrow containers (< 300px) - compact mode */
  @container post-card (max-width: 18.75rem) {
    .post-card__meta {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }

    .post-card__description {
      -webkit-line-clamp: 2;
    }
  }

  /* Wide containers (≥ 500px) - enhanced layout */
  @container post-card (min-width: 31.25rem) {
    .post-card__article {
      --card-padding: clamp(1.25rem, 1rem + 0.5vw, 1.75rem);
    }

    .post-card__title {
      font-size: clamp(1.125rem, 1rem + 0.375vw, 1.375rem);
    }

    .post-card__description {
      -webkit-line-clamp: 4;
    }
  }

  /* Extra wide containers (≥ 700px) - spacious layout */
  @container post-card (min-width: 43.75rem) {
    .post-card__article {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
    }

    .post-card__description {
      max-width: 90%;
    }
  }

  /* ==========================================================================
     VIEWPORT FALLBACKS
     ==========================================================================
     For browsers without container query support
     ========================================================================== */

  @supports not (container-type: inline-size) {
    @media (min-width: 31.25rem) {
      .post-card__article {
        padding: 1.5rem;
      }

      .post-card__title {
        font-size: 1.25rem;
      }
    }

    @media (max-width: 18.75rem) {
      .post-card__meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
    }
  }
</style>

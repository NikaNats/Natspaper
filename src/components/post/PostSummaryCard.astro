---
import { slugifyStr } from "@/utils/core";
import Datetime from "../post/Datetime.astro";
import ReadingTime from "../post/ReadingTime.astro";
import { getReadingTimeDisplay } from "@/utils/post";

export interface Props {
  title: string;
  description: string;
  pubDatetime: Date;
  modDatetime?: Date | null;
  timezone?: string;
  slug: string;
  variant?: "h2" | "h3";
  /** Approximate word count for reading time calculation */
  wordCount?: number;
  /** Show tags preview */
  tags?: string[];
  /** Mark as featured post */
  featured?: boolean;
}

const {
  title,
  description,
  pubDatetime,
  modDatetime,
  timezone,
  slug,
  variant = "h2",
  wordCount = 0,
  tags = [],
  featured = false,
} = Astro.props;

// REFACTORED: Use a dynamic tag to avoid repetition. This is the key change.
const HeadingTag = variant === "h2" ? "h2" : "h3";

// Calculate reading time if word count provided
const readingTimeText =
  wordCount > 0 ? getReadingTimeDisplay(" ".repeat(wordCount)) : "";

// Format tags for preview (show max 3)
const tagPreview = tags.slice(0, 3);
---

<li class="post-summary-item" data-testid="post-card">
  <a
    href={`/${Astro.currentLocale}/posts/${slug}`}
    class="group block no-underline focus-visible:outline-2 focus-visible:outline-offset-1 focus-visible:outline-accent focus-visible:outline-dashed"
  >
    <article
      class:list={[
        "post-entry rounded-lg border border-border/40 p-4 transition-all duration-200",
        "group-hover:border-accent/40 group-hover:bg-muted/30 group-hover:shadow-md",
        "group-focus-visible:border-accent/50 group-focus-visible:bg-muted/40",
        { "border-l-4 border-l-accent bg-muted/20": featured },
      ]}
    >
      <!-- Featured Badge -->
      {
        featured && (
          <div class="mb-2 inline-block rounded-full bg-accent/10 px-2.5 py-0.5 text-xs font-semibold text-accent">
            âœ¨ Featured
          </div>
        )
      }

      <!-- Title -->
      <HeadingTag
        class="text-lg font-bold text-foreground transition-colors duration-200 group-hover:text-accent"
        style={{ viewTransitionName: slugifyStr(title) }}
      >
        {title}
      </HeadingTag>

      <!-- Metadata Row: Date & Reading Time -->
      <div
        class="mt-3 flex flex-wrap items-center gap-4 text-sm text-text-secondary"
      >
        <Datetime {pubDatetime} {modDatetime} {timezone} />
        {readingTimeText && <ReadingTime text={readingTimeText} size="sm" />}
      </div>

      <!-- Description/Excerpt -->
      <p class="mt-3 line-clamp-3 leading-relaxed text-foreground">
        {description}
      </p>

      <!-- Tags Preview -->
      {
        tagPreview.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {tagPreview.map(tag => (
              <span class="inline-block rounded-full bg-muted px-2.5 py-1 text-xs font-medium text-text-secondary transition-colors duration-200 group-hover:bg-accent/10 group-hover:text-accent">
                #{tag}
              </span>
            ))}
            {tags.length > 3 && (
              <span class="inline-block text-xs text-text-secondary">
                +{tags.length - 3}
              </span>
            )}
          </div>
        )
      }
    </article>
  </a>
</li>

---
import { slugifyStr } from "@/utils/core";
import { calculateReadingTimeFromWords, formatReadingTime } from "@/utils/post";
import Datetime from "../post/Datetime.astro";
import ReadingTime from "../post/ReadingTime.astro";

export interface Props {
  title: string;
  description: string;
  pubDatetime: Date;
  modDatetime?: Date | null;
  timezone?: string;
  slug: string;
  variant?: "h2" | "h3";
  wordCount?: number;
  tags?: string[];
  featured?: boolean;
}

const {
  title,
  description,
  pubDatetime,
  modDatetime,
  timezone,
  slug,
  variant = "h2",
  wordCount = 0,
  tags = [],
  featured = false,
} = Astro.props;

// 1. Polymorphic Heading (Cleaner than ternary strings)
const Heading = variant;

// 2. Logic & Config
const href = `/${Astro.currentLocale}/posts/${slug}`;
const readingTime =
  wordCount > 0
    ? formatReadingTime(calculateReadingTimeFromWords(wordCount))
    : null;

// 3. Styles (DRY & readable template)
const cardStyles = [
  "post-entry rounded-lg border border-border/40 p-4 transition-all duration-200 bg-muted/30",
  "group-hover:border-accent/40 group-hover:bg-muted/30 group-hover:shadow-md",
  "group-focus-visible:border-accent/50 group-focus-visible:bg-muted/40",
  featured ? "border-l-4 border-l-accent bg-muted/20" : "",
];
---

<li class="post-summary-item" data-testid="post-card">
  <a
    {href}
    class="group block no-underline outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-1"
  >
    <article class:list={cardStyles}>
      {/* Featured Badge */}
      {
        featured && (
          <div class="mb-2 inline-block rounded-full bg-accent/10 px-2.5 py-0.5 text-xs font-semibold text-accent">
            âœ¨ Featured
          </div>
        )
      }

      {/* Title */}
      <Heading
        class="text-lg font-bold text-foreground transition-colors group-hover:text-accent"
        style={{ viewTransitionName: slugifyStr(title) }}
      >
        {title}
      </Heading>

      {/* Metadata */}
      <div
        class="mt-3 flex flex-wrap items-center gap-4 text-sm text-text-secondary"
      >
        <Datetime {pubDatetime} {modDatetime} {timezone} />
        {readingTime && <ReadingTime text={readingTime} size="sm" />}
      </div>

      {/* Description */}
      <p class="mt-3 line-clamp-3 leading-relaxed text-foreground">
        {description}
      </p>

      {/* Tags (Limit 3) */}
      {
        tags.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {tags.slice(0, 3).map(tag => (
              <span class="rounded-full bg-muted px-2.5 py-1 text-xs font-medium text-text-secondary transition-colors group-hover:bg-accent/10 group-hover:text-accent">
                #{tag}
              </span>
            ))}
            {tags.length > 3 && (
              <span class="text-xs text-text-secondary">
                +{tags.length - 3}
              </span>
            )}
          </div>
        )
      }
    </article>
  </a>
</li>

---
/**
 * Button Atom - Design System Foundation
 * =======================================
 * A fully configurable button component that serves as the atomic building block
 * for all clickable actions in the design system.
 *
 * DESIGN PATTERN: Atomic Design - Atom
 * - Context agnostic: Works in forms, nav bars, cards, modals
 * - Prop driven: All variants controlled via props, not CSS overrides
 * - Accessible: Full keyboard support, ARIA labels, focus states
 *
 * VARIANTS:
 * - primary: High-emphasis actions (Submit, Save, CTA)
 * - secondary: Medium-emphasis actions (Cancel, Back)
 * - ghost: Low-emphasis actions (Read more, View all)
 * - outline: Bordered button for secondary actions
 * - danger: Destructive actions (Delete, Remove)
 *
 * SIZES:
 * - sm: Compact UI (toolbars, dense lists)
 * - md: Default size (forms, cards)
 * - lg: Hero CTAs, prominent actions
 *
 * @example
 * ```astro
 * <Button variant="primary" size="md">Submit</Button>
 * <Button variant="ghost" size="sm" iconOnly aria-label="Close"><Icon name="x" /></Button>
 * <Button variant="outline" href="/about">Learn More</Button>
 * ```
 */

export interface Props {
  /** Visual variant */
  variant?: "primary" | "secondary" | "ghost" | "outline" | "danger";
  /** Size preset */
  size?: "sm" | "md" | "lg";
  /** Render as anchor tag if href provided */
  href?: string;
  /** Button type for form semantics */
  type?: "button" | "submit" | "reset";
  /** Disabled state */
  disabled?: boolean;
  /** Icon-only button (square, no text padding) */
  iconOnly?: boolean;
  /** Full width button */
  fullWidth?: boolean;
  /** Additional CSS classes */
  class?: string;
  /** Accessible label (required for iconOnly) */
  "aria-label"?: string;
  /** HTML id */
  id?: string;
  /** Title tooltip */
  title?: string;
  /** Rel attribute for links */
  rel?: string;
  /** Loading state */
  loading?: boolean;
}

const {
  variant = "primary",
  size = "md",
  href,
  type = "button",
  disabled = false,
  iconOnly = false,
  fullWidth = false,
  class: className = "",
  "aria-label": ariaLabel,
  id,
  title,
  rel,
  loading = false,
} = Astro.props;

// Determine element type
const Element = href && !disabled ? "a" : "button";
const isLink = Element === "a";

// Compute rel for external links
function computeRel(): string | undefined {
  if (!href) return undefined;
  if (rel) return rel;
  try {
    const url = new URL(href, Astro.url.origin);
    if (url.origin !== Astro.url.origin) {
      return "noopener noreferrer";
    }
  } catch {
    // Invalid URL, treat as internal
  }
  return undefined;
}

// Variant styles
const variantClasses: Record<NonNullable<Props["variant"]>, string> = {
  primary: [
    "bg-accent text-white",
    "hover:bg-accent/90",
    "active:bg-accent/80",
    "focus-visible:ring-accent/30",
  ].join(" "),
  secondary: [
    "bg-muted text-foreground",
    "hover:bg-muted/80",
    "active:bg-muted/70",
    "focus-visible:ring-muted/30",
  ].join(" "),
  ghost: [
    "bg-transparent text-foreground",
    "hover:bg-muted hover:text-accent",
    "active:bg-muted/80",
    "focus-visible:ring-accent/20",
  ].join(" "),
  outline: [
    "bg-transparent text-foreground border-2 border-border",
    "hover:border-accent hover:text-accent hover:bg-accent/5",
    "active:bg-accent/10",
    "focus-visible:ring-accent/20",
  ].join(" "),
  danger: [
    "bg-red-500 text-white",
    "hover:bg-red-600",
    "active:bg-red-700",
    "focus-visible:ring-red-500/30",
  ].join(" "),
};

// Size styles
const sizeClasses: Record<NonNullable<Props["size"]>, string> = {
  sm: iconOnly ? "p-1.5 text-sm" : "px-3 py-1.5 text-sm gap-1.5",
  md: iconOnly ? "p-2 text-base" : "px-4 py-2 text-base gap-2",
  lg: iconOnly ? "p-3 text-lg" : "px-6 py-3 text-lg gap-2.5",
};

// Icon size mappings
const iconSizeClasses: Record<NonNullable<Props["size"]>, string> = {
  sm: "[&>svg]:size-4",
  md: "[&>svg]:size-5",
  lg: "[&>svg]:size-6",
};

// Base classes
const baseClasses = [
  // Layout
  "inline-flex items-center justify-center",
  iconOnly ? "aspect-square" : "",
  fullWidth ? "w-full" : "",
  // Typography
  "font-medium whitespace-nowrap",
  // Shape
  "rounded-lg",
  // Transitions
  "transition-all duration-200",
  // Focus ring
  "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2",
  // Disabled state
  disabled || loading
    ? "opacity-50 cursor-not-allowed pointer-events-none"
    : "",
  // Active press effect
  "active:scale-[0.98]",
  // Cursor
  "cursor-pointer",
]
  .filter(Boolean)
  .join(" ");
---

{
  isLink ? (
    <a
      id={id}
      href={href}
      rel={computeRel()}
      class:list={[
        baseClasses,
        variantClasses[variant],
        sizeClasses[size],
        iconSizeClasses[size],
        className,
      ]}
      aria-label={ariaLabel}
      title={title}
    >
      {loading && (
        <svg
          class="mr-2 -ml-1 size-4 animate-spin"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          />
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
      )}
      <slot />
    </a>
  ) : (
    <button
      id={id}
      type={type}
      disabled={disabled || loading}
      class:list={[
        baseClasses,
        variantClasses[variant],
        sizeClasses[size],
        iconSizeClasses[size],
        className,
      ]}
      aria-label={ariaLabel}
      aria-disabled={disabled || loading}
      title={title}
    >
      {loading && (
        <svg
          class="mr-2 -ml-1 size-4 animate-spin"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          />
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
      )}
      <slot />
    </button>
  )
}

<style>
  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    a,
    button {
      transition: none;
    }
    a:active,
    button:active {
      transform: none;
    }
  }
</style>

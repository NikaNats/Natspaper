---
// REFACTORED: The Layout component is now a clean, high-level conductor.
import { ClientRouter } from "astro:transitions";
// FIX: Remove broken import from astro:env/client
// import { PUBLIC_GOOGLE_SITE_VERIFICATION } from "astro:env/client";
import { Font } from "astro:assets";
import { SITE, FEATURES } from "@/config";
import "@/styles/global.css";
import { getI18n, type Lang, LOCALE_CODES } from "@/i18n";

// PERFORMANCE FIX: Removed manual @fontsource imports.
// These are handled by 'experimental.fonts' in astro.config.ts.
// Manual imports here caused duplicate downloads and render blocking.

// Import our new, specialized components
import Seo from "@/components/features/Seo.astro";
import StructuredData from "@/components/features/StructuredData.astro";
import ThemeManager from "@/components/features/ThemeManager.astro";
import Analytics from "@/components/features/Analytics.astro";

// SEO: Structured data generators
import {
  generateBlogPostingSchema,
  generateWebSiteSchema,
  generateBreadcrumbSchema,
  combineSchemas,
} from "@/utils/seo";

// FIX: Access the environment variable directly
const PUBLIC_GOOGLE_SITE_VERIFICATION = import.meta.env
  .PUBLIC_GOOGLE_SITE_VERIFICATION;

// Get translations for current locale
const { t } = getI18n(Astro.currentLocale as Lang);
const currentLocale = (Astro.currentLocale ?? "en") as Lang;
const localeCode = LOCALE_CODES[currentLocale] ?? "en-US";

// The props interface remains the same, as it's the public API for the layout.
export interface Props {
  title?: string;
  author?: string;
  profile?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | null;
  scrollSmooth?: boolean;
  /** Tags/keywords for the content (used in structured data) */
  tags?: string[];
  /** Word count for blog posts (used in structured data) */
  wordCount?: number;
  /** Structured data for CreativeWorkSeries (used for series posts) */
  seriesSchema?: Record<string, unknown> | null;
}

const {
  title = SITE.title,
  author = SITE.author,
  profile = SITE.profile,
  description = SITE.desc,
  ogImage = SITE.ogImage ? `/${SITE.ogImage}` : "/og.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  pubDatetime,
  modDatetime,
  scrollSmooth = FEATURES.scrollSmooth,
  tags,
  wordCount,
  seriesSchema,
} = Astro.props;

// Build social image URL
const siteUrl = Astro.url.origin;
const socialImageURL = new URL(ogImage, siteUrl);
const pageUrl = canonicalURL.toString();

// Determine if this is a blog post (has pubDatetime) or a general page
const isBlogPost = Boolean(pubDatetime);

// Generate appropriate structured data based on page type
// Using type assertion since our schema interfaces extend Record<string, unknown>
let structuredData: Record<string, unknown>;

if (isBlogPost && pubDatetime) {
  // Blog post: Generate BlogPosting + Breadcrumb schema
  const blogPostingSchema = generateBlogPostingSchema({
    title,
    description,
    imageUrl: socialImageURL.toString(),
    datePublished: pubDatetime,
    dateModified: modDatetime,
    authorName: author,
    authorUrl: profile,
    pageUrl,
    siteUrl,
    wordCount,
    tags,
    locale: localeCode,
  });

  // Generate breadcrumb: Home > Posts > [Post Title]
  const breadcrumbSchema = generateBreadcrumbSchema([
    { name: t("nav.home"), url: `${siteUrl}/${currentLocale}/` },
    { name: t("nav.posts"), url: `${siteUrl}/${currentLocale}/posts/` },
    { name: title }, // Current page (no URL - Google recommendation)
  ]);

  structuredData = combineSchemas(
    blogPostingSchema as Record<string, unknown>,
    breadcrumbSchema as Record<string, unknown>,
    ...(seriesSchema ? [seriesSchema as Record<string, unknown>] : [])
  );
} else {
  // General page: Generate WebSite schema for homepage, or just breadcrumb for other pages
  const isHomePage =
    Astro.url.pathname === "/" ||
    Astro.url.pathname === `/${currentLocale}` ||
    Astro.url.pathname === `/${currentLocale}/`;

  if (isHomePage) {
    structuredData = generateWebSiteSchema({
      siteUrl,
      locale: localeCode,
    }) as Record<string, unknown>;
  } else {
    // Non-blog pages: Just breadcrumb schema
    structuredData = generateBreadcrumbSchema([
      { name: t("nav.home"), url: `${siteUrl}/${currentLocale}/` },
      { name: title }, // Current page
    ]) as Record<string, unknown>;
  }
}
---

<!doctype html>
<html
  dir={SITE.dir}
  lang={Astro.currentLocale ?? SITE.lang ?? "en"}
  class:list={[{ "scroll-smooth": scrollSmooth }]}
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Font loading remains a core layout concern -->
    <Font cssVariable="--font-inter" />
    <Font cssVariable="--font-georgian" />
    <Font cssVariable="--font-jetbrains-mono" />

    <!-- REFACTORED: Delegate all SEO concerns to the Seo component -->
    <Seo
      title={title}
      description={description}
      ogImage={ogImage}
      canonicalURL={canonicalURL.toString()}
      pubDatetime={pubDatetime}
      modDatetime={modDatetime}
    />

    <!-- REFACTORED: Delegate structured data to its own component -->
    <StructuredData data={structuredData} />

    <!-- REFACTORED: Delegate theme management to its own component -->
    <ThemeManager />

    <!-- Other essential head tags -->
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title={SITE.title}
      href={new URL(`${currentLocale}/rss.xml`, Astro.site)}
    />

    {
      PUBLIC_GOOGLE_SITE_VERIFICATION && (
        <meta
          name="google-site-verification"
          content={PUBLIC_GOOGLE_SITE_VERIFICATION}
        />
      )
    }

    <!-- Enable View Transitions -->
    <slot name="head" />
    <ClientRouter />
  </head>

  <body>
    <!-- WCAG 2.4.1: Skip to Main Content link for keyboard navigation -->
    <a href="#main-content" class="skip-link"> {t("nav.skipToContent")} </a>

    <slot />

    <!-- REFACTORED: Delegate analytics to its own component -->
    <Analytics />
  </body>
</html>

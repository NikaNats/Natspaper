---
// REFACTORED: The Layout component is now a clean, high-level conductor.
import { ClientRouter } from "astro:transitions";
import { PUBLIC_GOOGLE_SITE_VERIFICATION } from "astro:env/client";
import { Font } from "astro:assets";
import { SITE } from "@/config";
import "@/styles/global.css";

// Import our new, specialized components
import Seo from "@/components/Seo.astro";
import StructuredData from "@/components/StructuredData.astro";
import ThemeManager from "@/components/ThemeManager.astro";
import Analytics from "@/components/Analytics.astro";

// The props interface remains the same, as it's the public API for the layout.
export interface Props {
  title?: string;
  author?: string;
  profile?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | null;
  scrollSmooth?: boolean;
}

const {
  title = SITE.title,
  author = SITE.author,
  profile = SITE.profile,
  description = SITE.desc,
  ogImage = SITE.ogImage ? `/${SITE.ogImage}` : "/og.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  pubDatetime,
  modDatetime,
  scrollSmooth = false,
} = Astro.props;

// The logic to build the structured data remains here, in the "smart" component.
const socialImageURL = new URL(ogImage, Astro.url);

const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: `${title}`,
  image: `${socialImageURL}`,
  datePublished: `${pubDatetime?.toISOString()}`,
  ...(modDatetime && { dateModified: modDatetime.toISOString() }),
  author: [
    {
      "@type": "Person",
      name: `${author}`,
      ...(profile && { url: profile }),
    },
  ],
};
---

<!doctype html>
<html
  dir={SITE.dir}
  lang={Astro.currentLocale ?? SITE.lang ?? "en"}
  class:list={[{ "scroll-smooth": scrollSmooth }]}
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Font loading remains a core layout concern -->
    <Font cssVariable="--font-inter" preload />
    <Font cssVariable="--font-merriweather" />
    <Font cssVariable="--font-jetbrains-mono" />

    <!-- REFACTORED: Delegate all SEO concerns to the Seo component -->
    <Seo
      title={title}
      description={description}
      ogImage={ogImage}
      canonicalURL={canonicalURL.toString()}
      pubDatetime={pubDatetime}
      modDatetime={modDatetime}
    />

    <!-- REFACTORED: Delegate structured data to its own component -->
    <StructuredData data={structuredData} />

    <!-- REFACTORED: Delegate theme management to its own component -->
    <ThemeManager />

    <!-- Other essential head tags -->
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title={SITE.title}
      href={new URL("rss.xml", Astro.site)}
    />

    {
      PUBLIC_GOOGLE_SITE_VERIFICATION && (
        <meta
          name="google-site-verification"
          content={PUBLIC_GOOGLE_SITE_VERIFICATION}
        />
      )
    }

    <!-- Enable View Transitions -->
    <slot name="head" />
    <ClientRouter />
  </head>

  <body>
    <slot />

    <!-- REFACTORED: Delegate analytics to its own component -->
    <Analytics />
  </body>
</html>

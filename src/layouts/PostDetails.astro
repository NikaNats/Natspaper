---
// src/layouts/PostDetails.astro
import { render, type CollectionEntry } from "astro:content";
import { SITE, FEATURES } from "@/config";
import { getI18n } from "@/i18n";
import { LANGUAGES, type Lang } from "@/i18n/config";
import {
  resolveOgImageUrl,
  getAdjacentPosts,
  getReadingTimeDisplay,
} from "@/utils/post";
import { getLastPathSegment } from "@/utils/core/slugify";
import { PostRepository } from "@/utils/post/repository";
import type { BreadcrumbItem } from "@/types"; // <--- 1. Import the type

// Components
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import Breadcrumb from "@/components/ui/Breadcrumb.astro";
import PostHero from "@/components/post/PostHero.astro";
import PostContent from "@/components/post/PostContent.astro";
import PostFooter from "@/components/post/PostFooter.astro";
import TableOfContents from "@/components/post/TableOfContents.astro";
import MobileTableOfContents from "@/components/post/MobileTableOfContents.astro";
import SeriesBox from "@/components/post/SeriesBox.astro";
import Bibliography from "@/components/post/Bibliography.astro";

import "katex/dist/katex.min.css";

export interface Props {
  post: CollectionEntry<"blog">;
  posts: CollectionEntry<"blog">[];
  isFallback?: boolean;
  originalLocale?: Lang;
}

const { post, posts, isFallback = false, originalLocale } = Astro.props;
const {
  title,
  author,
  description,
  ogImage: initOgImage,
  canonicalURL: frontmatterCanonical,
  pubDatetime,
  modDatetime,
  timezone,
  tags,
  hideEditPost,
} = post.data;

const { Content, headings } = await render(post);

// 1. Data Preparation
const locale = (Astro.currentLocale as Lang) || "en";
const { t, tTag } = getI18n(locale);
const readingTimeText = getReadingTimeDisplay(post.body || "");
const ogImage = resolveOgImageUrl(initOgImage, post.slug, Astro.url.origin);

// 2. Fetch Series Data
const seriesParts = post.data.series
  ? await PostRepository.getSeries(post.data.series.id, locale)
  : [];

// 3. Breadcrumb Navigation Logic (Fixed Redeclaration & Typing)
const postsHref = locale === "en" ? "/en/posts" : `/${locale}/posts`;
const breadcrumbItems: BreadcrumbItem[] = [
  // <--- 2. Explicitly type the array
  { label: t("nav.home"), href: `/${locale}` },
  { label: t("nav.posts"), href: postsHref },
];

if (post.data.series) {
  // Use series title, but truncate if too long for breadcrumbs
  const seriesTitle =
    post.data.series.title.length > 30
      ? post.data.series.title.substring(0, 27) + "..."
      : post.data.series.title;
  breadcrumbItems.push({ label: seriesTitle }); // No href needed for text-only
}
breadcrumbItems.push({ label: title });

// 4. Navigation Override (Prev/Next logic)
let { previous: prevPost, next: nextPost } = getAdjacentPosts(posts, post.id);

if (seriesParts.length > 0) {
  const idx = seriesParts.findIndex(p => p.post.id === post.id);
  if (idx > 0 && idx < seriesParts.length) {
    const p = seriesParts[idx - 1]?.post;
    if (p) {
      prevPost = { id: p.id, title: p.data.title, filePath: p.filePath };
    }
  }
  if (idx >= 0 && idx < seriesParts.length - 1) {
    const n = seriesParts[idx + 1]?.post;
    if (n) {
      nextPost = { id: n.id, title: n.data.title, filePath: n.filePath };
    }
  }
}

// 5. Config & Helpers
const editPostConfig = FEATURES.editPost;
const showEditPost = !!(
  editPostConfig.enabled &&
  !hideEditPost &&
  editPostConfig.url
);
const currentYear = new Date().getFullYear();
const copyrightText = `Copyright © ${currentYear} • ${t("footer.copyright")}`;

// 6. Advanced SEO (CreativeWorkSeries)
const seriesSchema = post.data.series
  ? {
      "@type": "CreativeWorkSeries",
      name: post.data.series.title,
      hasPart: seriesParts.map(p => ({
        "@type": "BlogPosting",
        headline: p.post.data.title,
        url: new URL(
          `/${locale}/posts/${getLastPathSegment(p.post.slug)}`,
          SITE.website
        ).href,
      })),
    }
  : null;

// 7. SEO: Handle Fallback Canonical
const canonicalURL =
  isFallback && originalLocale
    ? new URL(
        `/${originalLocale}/posts/${post.slug.split("/").pop()}`,
        SITE.website
      ).href
    : frontmatterCanonical;

const originalLangName = originalLocale
  ? LANGUAGES[originalLocale as Lang]
  : "";
const contentLang = isFallback && originalLocale ? originalLocale : locale;
---

<Layout
  title={`${title} | ${SITE.title}`}
  author={author}
  description={description}
  pubDatetime={pubDatetime}
  modDatetime={modDatetime}
  canonicalURL={canonicalURL}
  ogImage={ogImage}
  tags={tags}
  wordCount={post.body?.split(/\s+/).length}
  scrollSmooth
  seriesSchema={seriesSchema}
>
  <Header />

  <!--
  RESPONSIVE ARTICLE LAYOUT - Centering Strategy
  ================================================
  Uses a three-layer centering approach for optimal readability:
  
  1. OUTER WRAPPER (.article-layout)
     - Container queries for component-level responsiveness
     - Fluid horizontal padding that scales with viewport
     - Centers the entire article block
  
  2. CONTENT CONTAINER (.article-container)
     - Fixed 720px width for optimal line length
     - Centered within the outer wrapper
     - Responsive vertical spacing
  
  3. DESKTOP SIDEBAR (TOC)
     - Positioned outside content flow on xl+ screens
     - Sticky positioning for scroll-following
     - Hidden on mobile/tablet for cleaner mobile experience
  -->

  <div class="article-layout">
    <!-- Desktop Sidebar (TOC) -->
    <aside class="article-sidebar" aria-label="Table of contents">
      <div class="article-sidebar__inner">
        <TableOfContents {headings} />
      </div>
    </aside>

    <!-- Main Article Content -->
    <main id="main-content" class="article-container">
      <!-- Breadcrumb Navigation -->
      <Breadcrumb items={breadcrumbItems} class="mb-4" />

      <!-- Fallback Notice -->
      {
        isFallback && (
          <div class="mb-8 flex items-center gap-3 rounded-lg border border-amber-500/30 bg-amber-500/10 px-4 py-3 text-sm text-amber-700 dark:text-amber-400">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="size-5 shrink-0"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="12" y1="16" x2="12" y2="12" />
              <line x1="12" y1="8" x2="12.01" y2="8" />
            </svg>
            <span>
              {locale === "ka"
                ? `ეს სტატია ჯერ არ არის თარგმნილი ქართულად. ნაჩვენებია ${originalLangName} ვერსია.`
                : `This content is not available in your language. Showing ${originalLangName} version.`}
            </span>
          </div>
        )
      }

      <PostHero
        {title}
        {pubDatetime}
        {modDatetime}
        {timezone}
        {readingTimeText}
      />

      <!-- 2. Restore logic: Hide ONLY when sidebar appears (xl/2xl breakpoint) -->
      <!-- Using 'xl:hidden' or matching your sidebar breakpoint (min-width: 80rem) -->
      <div class="block xl:hidden">
        <MobileTableOfContents headings={headings} />
      </div>

      {
        seriesParts.length > 0 && (
          <SeriesBox
            seriesParts={seriesParts}
            currentPostId={post.id}
            locale={locale}
          />
        )
      }

      <PostContent contentLang={contentLang}>
        <Content />
      </PostContent>

      {
        post.data.references && post.data.references.length > 0 && (
          <Bibliography references={post.data.references} locale={locale} />
        )
      }

      <PostFooter
        {tags}
        {showEditPost}
        {editPostConfig}
        {post}
        {prevPost}
        {nextPost}
        {tTag}
        locale={Astro.currentLocale}
      />
    </main>
  </div>

  <Footer {copyrightText} />
</Layout>

<style>
  /* ==========================================================================
     RESPONSIVE ARTICLE LAYOUT - Simple Centering Strategy
     ==========================================================================
     Clean, simple layout that:
     - Centers content at fixed 720px width
     - Uses absolute positioning for sidebar
     - Works consistently across all resolutions
     ========================================================================== */

  .article-layout {
    /* Layout positioning - centered container */
    position: relative;
    width: 100%;
    max-width: calc(var(--main-width) + 2rem); /* 720px content + padding */
    margin-inline: auto;
    padding-inline: 1rem;
    padding-block: 2rem 3rem;
  }

  /* Remove padding once we have enough space for full width */
  @media (min-width: 752px) {
    .article-layout {
      max-width: var(--main-width);
      padding-inline: 0;
    }
  }

  /* ==========================================================================
     MAIN CONTENT CONTAINER
     ========================================================================== */

  .article-container {
    /* Full width within the centered container */
    width: 100%;

    /* Critical: Prevent overflow from wide children (code blocks, tables) */
    min-width: 0;
  }

  /* ==========================================================================
     DESKTOP SIDEBAR (Table of Contents)
     ========================================================================== */

  .article-sidebar {
    /* Hidden by default on mobile/tablet */
    display: none;
  }

  .article-sidebar__inner {
    /* Sticky positioning */
    position: sticky;
    top: calc(var(--header-height, 64px) + 1.5rem);

    /* Visual styling */
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .article-sidebar__inner:hover {
    opacity: 1;
  }

  /* ==========================================================================
     DESKTOP LAYOUT - Absolute Positioned Sidebar
     ==========================================================================
     Uses absolute positioning to place sidebar outside content flow.
     This keeps main content perfectly centered regardless of sidebar.
     ========================================================================== */

  @media (min-width: 80rem) {
    .article-sidebar {
      /* Absolute position to the left of centered content */
      display: block;
      position: absolute;
      top: 2rem;
      right: 100%;
      width: 14rem;
      height: 100%;
      margin-right: 3rem;
    }
  }

  /* Extra wide screens - Larger sidebar */
  @media (min-width: 100rem) {
    .article-sidebar {
      width: 16rem;
      margin-right: 4rem;
    }
  }

  /* ==========================================================================
     REDUCED MOTION
     ========================================================================== */

  @media (prefers-reduced-motion: reduce) {
    .article-sidebar__inner {
      transition: none;
    }
  }
</style>

<script>
  import { featureManager } from "@/utils/features/FeatureManager";

  // Lifecycle Event Manager
  const init = () => {
    featureManager.initializeFeatures();
    // Reset scroll only on navigation, logic handled by listener type
    if (document.documentElement.scrollTop > 0)
      window.scrollTo({ left: 0, top: 0, behavior: "instant" });
  };

  const cleanup = () => featureManager.cleanupFeatures();

  document.addEventListener("astro:page-load", () =>
    featureManager.initializeFeatures()
  );
  document.addEventListener("astro:after-swap", init);
  document.addEventListener("astro:before-swap", cleanup);
</script>

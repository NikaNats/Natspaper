---
import { render, type CollectionEntry } from "astro:content";
import { SITE } from "@/config";
import { getI18n } from "@/i18n";
import { slugifyStr } from "@/utils/core";
import {
  resolveOgImageUrl,
  getAdjacentPosts,
  getReadingTimeDisplay,
} from "@/utils/post";

// Components
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import Tag from "@/components/post/Tag.astro";
import Datetime from "@/components/post/Datetime.astro";
import ReadingTime from "@/components/post/ReadingTime.astro";
import EditPost from "@/components/features/EditPost.astro";
import ShareLinks from "@/components/features/ShareLinks.astro";
import BackToTopButton from "@/components/features/BackToTopButton.astro";
import Hr from "@/components/ui/Hr.astro";

// Assets
import IconChevronLeft from "@/assets/icons/IconChevronLeft.svg";
import IconChevronRight from "@/assets/icons/IconChevronRight.svg";
import IconHash from "@/assets/icons/IconHash.svg";
import katexStyles from "katex/dist/katex.min.css?url";

export interface Props {
  post: CollectionEntry<"blog">;
  posts: CollectionEntry<"blog">[];
}

const { post, posts } = Astro.props;
const {
  title,
  author,
  description,
  ogImage: initOgImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  timezone,
  tags,
  hideEditPost,
} = post.data;
const { Content } = await render(post);

// 1. Data Preparation
const { t, tTag } = getI18n(Astro.currentLocale as "en" | "ka" | undefined);
const readingTimeText = getReadingTimeDisplay(post.body || "");
const ogImage = resolveOgImageUrl(initOgImage, post.slug, Astro.url.origin);
const { previous: prevPost, next: nextPost } = getAdjacentPosts(posts, post.id);

// 2. Config & Helpers
const editPostConfig = SITE.editPost;
const showEditPost =
  editPostConfig.enabled && !hideEditPost && editPostConfig.url;
const currentYear = new Date().getFullYear();
const copyrightText = `Copyright © ${currentYear} • ${t("footer.copyright")}`;

// FIX: Relaxed type definition to accept both CollectionEntry and NavigationPost
const getPostHref = (p: { id: string }) =>
  `/${Astro.currentLocale}/posts/${String(p.id).split("/").slice(-1)[0]}`;

// Shared Tailwind Classes (DRY)
const navLinkClasses =
  "group relative flex flex-col gap-1 overflow-hidden rounded-xl border border-border/60 p-6 transition-all hover:border-accent/40 hover:bg-muted/40 hover:shadow-sm h-full";
const navDecorationClasses =
  "absolute top-0 h-full w-1 bg-border/50 transition-colors group-hover:bg-accent/50";
---

<Layout
  title={`${title} | ${SITE.title}`}
  author={author}
  description={description}
  pubDatetime={pubDatetime}
  modDatetime={modDatetime}
  canonicalURL={canonicalURL}
  ogImage={ogImage}
  scrollSmooth
>
  <!-- Resource Hints: 'onload' logic retained for non-blocking CSS loading -->
  <link
    slot="head"
    rel="stylesheet"
    href={katexStyles}
    media="print"
    onload="this.media='all'"
  />
  <noscript slot="head"><link rel="stylesheet" href={katexStyles} /></noscript>

  <Header />

  <main
    id="main-content"
    class:list={[
      "mx-auto w-full max-w-3xl px-4",
      { "mt-12": !SITE.showBackButton },
    ]}
    data-pagefind-body
  >
    <!-- Hero Section -->
    <header class="mx-auto mt-10 mb-14 max-w-3xl text-center">
      <h1
        transition:name={slugifyStr(title)}
        class="mb-6 text-4xl font-bold tracking-tight sm:text-5xl"
        data-testid="post-title"
      >
        {title}
      </h1>
      <div
        class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 text-sm text-text-secondary"
      >
        <Datetime {pubDatetime} {modDatetime} {timezone} size="sm" />
        <span class="text-border" aria-hidden="true">/</span>
        <ReadingTime text={readingTimeText} size="sm" />
      </div>
    </header>

    <!-- Article Content -->
    <article
      id="article"
      class="app-prose mx-auto max-w-none prose-headings:text-center prose-img:rounded-xl prose-img:shadow-sm"
      data-testid="post-content"
    >
      <Content />
    </article>

    <!-- Post Footer / Actions -->
    <footer class="mx-auto mt-14 max-w-3xl">
      <Hr class="mb-14" aria-hidden="true" />

      <!-- Topics -->
      {
        tags.length > 0 && (
          <nav aria-label="Topics" class="mb-12 space-y-3">
            <div class="flex items-center gap-2 pl-1 text-xs font-bold tracking-widest text-text-secondary uppercase opacity-75">
              <IconHash class="size-3.5 opacity-60" /> <span>Topics</span>
            </div>
            <ul class="flex flex-wrap gap-2">
              {tags.map(tag => (
                <Tag tag={slugifyStr(tag)} tagName={tTag(tag)} />
              ))}
            </ul>
          </nav>
        )
      }

      <!-- Toolbar -->
      <div
        class="mb-16 flex flex-col items-center justify-between gap-4 rounded-2xl border border-border/50 bg-muted/30 px-4 py-4 sm:flex-row sm:px-6"
      >
        <ShareLinks />
        <div
          class="flex w-full items-center justify-center gap-4 border-t border-border/40 pt-4 sm:w-auto sm:justify-end sm:border-0 sm:pt-0"
        >
          {
            showEditPost && (
              <EditPost
                href={`${editPostConfig.url}${post.filePath}`}
                text={editPostConfig.text}
              />
            )
          }
          <BackToTopButton />
        </div>
      </div>

      <!-- Navigation -->
      <nav
        class="grid grid-cols-1 gap-6 sm:grid-cols-2"
        aria-label="Post Navigation"
      >
        {/* Previous Post */}
        {
          prevPost ? (
            <a href={getPostHref(prevPost)} class={navLinkClasses}>
              <span class={`${navDecorationClasses} left-0`} />
              <span class="mb-1 flex items-center gap-2 text-xs font-bold tracking-wider text-text-secondary uppercase group-hover:text-accent">
                <IconChevronLeft class="size-3 transition-transform group-hover:-translate-x-1" />{" "}
                Previous Article
              </span>
              <span class="line-clamp-2 font-medium text-foreground group-hover:text-accent">
                {prevPost.title}
              </span>
            </a>
          ) : (
            <div />
          )
        }

        {/* Next Post */}
        {
          nextPost && (
            <a
              href={getPostHref(nextPost)}
              class={`${navLinkClasses} items-end text-right`}
            >
              <span class={`${navDecorationClasses} right-0`} />
              <span class="mb-1 flex items-center gap-2 text-xs font-bold tracking-wider text-text-secondary uppercase group-hover:text-accent">
                Next Article{" "}
                <IconChevronRight class="size-3 transition-transform group-hover:translate-x-1" />
              </span>
              <span class="line-clamp-2 font-medium text-foreground group-hover:text-accent">
                {nextPost.title}
              </span>
            </a>
          )
        }
      </nav>
    </footer>
  </main>

  <Footer {copyrightText} />
</Layout>

<script>
  import { featureManager } from "@/utils/features/FeatureManager";

  // Lifecycle Event Manager
  const init = () => {
    featureManager.initializeFeatures();
    // Reset scroll only on navigation, logic handled by listener type
    if (document.documentElement.scrollTop > 0)
      window.scrollTo({ left: 0, top: 0, behavior: "instant" });
  };

  const cleanup = () => featureManager.cleanupFeatures();

  document.addEventListener("astro:page-load", () =>
    featureManager.initializeFeatures()
  );
  document.addEventListener("astro:after-swap", init);
  document.addEventListener("astro:before-swap", cleanup);
</script>

---
import { render, type CollectionEntry } from "astro:content";
import { SITE } from "@/config";
import { getI18n } from "@/i18n";
import {
  resolveOgImageUrl,
  getAdjacentPosts,
  getReadingTimeDisplay,
} from "@/utils/post";

// Components
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import PostHero from "@/components/post/PostHero.astro";
import PostContent from "@/components/post/PostContent.astro";
import PostFooter from "@/components/post/PostFooter.astro";

// Assets
import katexStyles from "katex/dist/katex.min.css?url";

export interface Props {
  post: CollectionEntry<"blog">;
  posts: CollectionEntry<"blog">[];
}

const { post, posts } = Astro.props;
const {
  title,
  author,
  description,
  ogImage: initOgImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  timezone,
  tags,
  hideEditPost,
} = post.data;
const { Content } = await render(post);

// 1. Data Preparation
const { t, tTag } = getI18n(Astro.currentLocale as "en" | "ka" | undefined);
const readingTimeText = getReadingTimeDisplay(post.body || "");
const ogImage = resolveOgImageUrl(initOgImage, post.slug, Astro.url.origin);
const { previous: prevPost, next: nextPost } = getAdjacentPosts(posts, post.id);

// 2. Config & Helpers
const editPostConfig = SITE.editPost;
const showEditPost = !!(
  editPostConfig.enabled &&
  !hideEditPost &&
  editPostConfig.url
);
const currentYear = new Date().getFullYear();
const copyrightText = `Copyright © ${currentYear} • ${t("footer.copyright")}`;
---

<Layout
  title={`${title} | ${SITE.title}`}
  author={author}
  description={description}
  pubDatetime={pubDatetime}
  modDatetime={modDatetime}
  canonicalURL={canonicalURL}
  ogImage={ogImage}
  scrollSmooth
>
  <!-- Resource Hints: 'onload' logic retained for non-blocking CSS loading -->
  <link
    slot="head"
    rel="stylesheet"
    href={katexStyles}
    media="print"
    onload="this.media='all'"
  />
  <noscript slot="head"><link rel="stylesheet" href={katexStyles} /></noscript>

  <Header />

  <main
    id="main-content"
    class:list={[
      "mx-auto w-full max-w-3xl px-4",
      { "mt-12": !SITE.showBackButton },
    ]}
    data-pagefind-body
  >
    <!-- Single Responsibility: This component only renders the Hero -->
    <PostHero
      {title}
      {pubDatetime}
      {modDatetime}
      {timezone}
      {readingTimeText}
    />

    <!-- Article Content -->
    <PostContent>
      <Content />
    </PostContent>

    <!-- Single Responsibility: This component handles meta/sharing/navigation -->
    <PostFooter
      {tags}
      {showEditPost}
      {editPostConfig}
      {post}
      {prevPost}
      {nextPost}
      {tTag}
    />
  </main>

  <Footer {copyrightText} />
</Layout>

<script>
  import { featureManager } from "@/utils/features/FeatureManager";

  // Lifecycle Event Manager
  const init = () => {
    featureManager.initializeFeatures();
    // Reset scroll only on navigation, logic handled by listener type
    if (document.documentElement.scrollTop > 0)
      window.scrollTo({ left: 0, top: 0, behavior: "instant" });
  };

  const cleanup = () => featureManager.cleanupFeatures();

  document.addEventListener("astro:page-load", () =>
    featureManager.initializeFeatures()
  );
  document.addEventListener("astro:after-swap", init);
  document.addEventListener("astro:before-swap", cleanup);
</script>

---
import { render, type CollectionEntry } from "astro:content";
import { SITE, FEATURES } from "@/config";
import { getI18n } from "@/i18n";
import {
  resolveOgImageUrl,
  getAdjacentPosts,
  getReadingTimeDisplay,
} from "@/utils/post";

// Components
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import PostHero from "@/components/post/PostHero.astro";
import PostContent from "@/components/post/PostContent.astro";
import PostFooter from "@/components/post/PostFooter.astro";
import TableOfContents from "@/components/post/TableOfContents.astro";
// REMOVED: MobileTableOfContents - TOC now only on desktop sidebar

// PERFORMANCE: Bundle critical CSS for math rendering
import "katex/dist/katex.min.css";

export interface Props {
  post: CollectionEntry<"blog">;
  posts: CollectionEntry<"blog">[];
}

const { post, posts } = Astro.props;
const {
  title,
  author,
  description,
  ogImage: initOgImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  timezone,
  tags,
  hideEditPost,
} = post.data;
const { Content, headings } = await render(post);

// 1. Data Preparation
const { t, tTag } = getI18n(Astro.currentLocale as "en" | "ka" | undefined);
const readingTimeText = getReadingTimeDisplay(post.body || "");
const ogImage = resolveOgImageUrl(initOgImage, post.slug, Astro.url.origin);
const { previous: prevPost, next: nextPost } = getAdjacentPosts(posts, post.id);

// 2. Config & Helpers
const editPostConfig = FEATURES.editPost;
const showEditPost = !!(
  editPostConfig.enabled &&
  !hideEditPost &&
  editPostConfig.url
);
const currentYear = new Date().getFullYear();
const copyrightText = `Copyright © ${currentYear} • ${t("footer.copyright")}`;
---

<Layout
  title={`${title} | ${SITE.title}`}
  author={author}
  description={description}
  pubDatetime={pubDatetime}
  modDatetime={modDatetime}
  canonicalURL={canonicalURL}
  ogImage={ogImage}
  scrollSmooth
>
  <Header />

  <!--
  RESPONSIVE LAYOUT ARCHITECTURE:
  1. Base: Single column, fluid width, standard padding (px-4).
  2. xl (Desktop): Absolute positioned sidebar to the left of centered content.
  3. Max-width: 3xl to match header width and center content perfectly.
  -->

  <div class="relative mx-auto mt-8 w-full max-w-3xl px-4 lg:mt-12">
    <!--
    DESKTOP SIDEBAR (TOC):
    - Hidden on mobile/tablet.
    - Absolute positioned to the left of the main container.
    - Sticky within its container to follow user reading.
    -->
    <aside
      class="absolute top-0 right-full mr-12 hidden h-full w-64 xl:block"
      aria-hidden="true"
    >
      <div
        class="sticky top-28 opacity-70 transition-opacity hover:opacity-100"
      >
        <TableOfContents {headings} />
      </div>
    </aside>

    <!--
    MAIN CONTENT AREA:
    - min-w-0: CRITICAL CSS FIX. Prevents flex items from overflowing
      when they contain wide children (like code blocks or tables).
      Without this, <pre> tags push the layout width out on mobile/tablet.
    - Takes full width of the max-w-3xl container.
    -->
    <main id="main-content" class="mx-auto w-full min-w-0" data-pagefind-body>
      <PostHero
        {title}
        {pubDatetime}
        {modDatetime}
        {timezone}
        {readingTimeText}
      />

      <PostContent>
        <Content />
      </PostContent>

      <PostFooter
        {tags}
        {showEditPost}
        {editPostConfig}
        {post}
        {prevPost}
        {nextPost}
        {tTag}
        locale={Astro.currentLocale}
      />
    </main>
  </div>

  <Footer {copyrightText} />
</Layout>

<script>
  import { featureManager } from "@/utils/features/FeatureManager";

  // Lifecycle Event Manager
  const init = () => {
    featureManager.initializeFeatures();
    // Reset scroll only on navigation, logic handled by listener type
    if (document.documentElement.scrollTop > 0)
      window.scrollTo({ left: 0, top: 0, behavior: "instant" });
  };

  const cleanup = () => featureManager.cleanupFeatures();

  document.addEventListener("astro:page-load", () =>
    featureManager.initializeFeatures()
  );
  document.addEventListener("astro:after-swap", init);
  document.addEventListener("astro:before-swap", cleanup);
</script>

---
import { render, type CollectionEntry } from "astro:content";
import { SITE, FEATURES } from "@/config";
import { getI18n } from "@/i18n";
import {
  resolveOgImageUrl,
  getAdjacentPosts,
  getReadingTimeDisplay,
} from "@/utils/post";

// Components
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import PostHero from "@/components/post/PostHero.astro";
import PostContent from "@/components/post/PostContent.astro";
import PostFooter from "@/components/post/PostFooter.astro";
import TableOfContents from "@/components/post/TableOfContents.astro";
import MobileTableOfContents from "@/components/post/MobileTableOfContents.astro";

// PERFORMANCE: Bundle critical CSS for math rendering
import "katex/dist/katex.min.css";

export interface Props {
  post: CollectionEntry<"blog">;
  posts: CollectionEntry<"blog">[];
}

const { post, posts } = Astro.props;
const {
  title,
  author,
  description,
  ogImage: initOgImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  timezone,
  tags,
  hideEditPost,
} = post.data;
const { Content, headings } = await render(post);

// 1. Data Preparation
const { t, tTag } = getI18n(Astro.currentLocale as "en" | "ka" | undefined);
const readingTimeText = getReadingTimeDisplay(post.body || "");
const ogImage = resolveOgImageUrl(initOgImage, post.slug, Astro.url.origin);
const { previous: prevPost, next: nextPost } = getAdjacentPosts(posts, post.id);

// 2. Config & Helpers
const editPostConfig = FEATURES.editPost;
const showEditPost = !!(
  editPostConfig.enabled &&
  !hideEditPost &&
  editPostConfig.url
);
const currentYear = new Date().getFullYear();
const copyrightText = `Copyright © ${currentYear} • ${t("footer.copyright")}`;
---

<Layout
  title={`${title} | ${SITE.title}`}
  author={author}
  description={description}
  pubDatetime={pubDatetime}
  modDatetime={modDatetime}
  canonicalURL={canonicalURL}
  ogImage={ogImage}
  tags={tags}
  wordCount={post.body?.split(/\s+/).length}
  scrollSmooth
>
  <Header />

  <!--
  RESPONSIVE ARTICLE LAYOUT - Centering Strategy
  ================================================
  Uses a three-layer centering approach for optimal readability:
  
  1. OUTER WRAPPER (.article-layout)
     - Container queries for component-level responsiveness
     - Fluid horizontal padding that scales with viewport
     - Centers the entire article block
  
  2. CONTENT CONTAINER (.article-container)
     - Fixed 720px width for optimal line length
     - Centered within the outer wrapper
     - Responsive vertical spacing
  
  3. DESKTOP SIDEBAR (TOC)
     - Positioned outside content flow on xl+ screens
     - Sticky positioning for scroll-following
     - Hidden on mobile/tablet for cleaner mobile experience
  -->

  <div class="article-layout">
    <!-- Desktop Sidebar (TOC) -->
    <aside class="article-sidebar" aria-label="Table of contents">
      <div class="article-sidebar__inner">
        <TableOfContents {headings} />
      </div>
    </aside>

    <!-- Main Article Content -->
    <main id="main-content" class="article-container" data-pagefind-body>
      <PostHero
        {title}
        {pubDatetime}
        {modDatetime}
        {timezone}
        {readingTimeText}
      />

      <!-- 2. Restore logic: Hide ONLY when sidebar appears (xl/2xl breakpoint) -->
      <!-- Using 'xl:hidden' or matching your sidebar breakpoint (min-width: 80rem) -->
      <div class="block xl:hidden">
        <MobileTableOfContents headings={headings} />
      </div>

      <PostContent>
        <Content />
      </PostContent>

      <PostFooter
        {tags}
        {showEditPost}
        {editPostConfig}
        {post}
        {prevPost}
        {nextPost}
        {tTag}
        locale={Astro.currentLocale}
      />
    </main>
  </div>

  <Footer {copyrightText} />
</Layout>

<style>
  /* ==========================================================================
     RESPONSIVE ARTICLE LAYOUT - Simple Centering Strategy
     ==========================================================================
     Clean, simple layout that:
     - Centers content at fixed 720px width
     - Uses absolute positioning for sidebar
     - Works consistently across all resolutions
     ========================================================================== */

  .article-layout {
    /* Layout positioning - centered container */
    position: relative;
    width: 100%;
    max-width: calc(var(--main-width) + 2rem); /* 720px content + padding */
    margin-inline: auto;
    padding-inline: 1rem;
    padding-block: 2rem 3rem;
  }

  /* Remove padding once we have enough space for full width */
  @media (min-width: 752px) {
    .article-layout {
      max-width: var(--main-width);
      padding-inline: 0;
    }
  }

  /* ==========================================================================
     MAIN CONTENT CONTAINER
     ========================================================================== */

  .article-container {
    /* Full width within the centered container */
    width: 100%;

    /* Critical: Prevent overflow from wide children (code blocks, tables) */
    min-width: 0;
  }

  /* ==========================================================================
     DESKTOP SIDEBAR (Table of Contents)
     ========================================================================== */

  .article-sidebar {
    /* Hidden by default on mobile/tablet */
    display: none;
  }

  .article-sidebar__inner {
    /* Sticky positioning */
    position: sticky;
    top: calc(var(--header-height, 64px) + 1.5rem);

    /* Visual styling */
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .article-sidebar__inner:hover {
    opacity: 1;
  }

  /* ==========================================================================
     DESKTOP LAYOUT - Absolute Positioned Sidebar
     ==========================================================================
     Uses absolute positioning to place sidebar outside content flow.
     This keeps main content perfectly centered regardless of sidebar.
     ========================================================================== */

  @media (min-width: 80rem) {
    .article-sidebar {
      /* Absolute position to the left of centered content */
      display: block;
      position: absolute;
      top: 2rem;
      right: 100%;
      width: 14rem;
      height: 100%;
      margin-right: 3rem;
    }
  }

  /* Extra wide screens - Larger sidebar */
  @media (min-width: 100rem) {
    .article-sidebar {
      width: 16rem;
      margin-right: 4rem;
    }
  }

  /* ==========================================================================
     REDUCED MOTION
     ========================================================================== */

  @media (prefers-reduced-motion: reduce) {
    .article-sidebar__inner {
      transition: none;
    }
  }
</style>

<script>
  import { featureManager } from "@/utils/features/FeatureManager";

  // Lifecycle Event Manager
  const init = () => {
    featureManager.initializeFeatures();
    // Reset scroll only on navigation, logic handled by listener type
    if (document.documentElement.scrollTop > 0)
      window.scrollTo({ left: 0, top: 0, behavior: "instant" });
  };

  const cleanup = () => featureManager.cleanupFeatures();

  document.addEventListener("astro:page-load", () =>
    featureManager.initializeFeatures()
  );
  document.addEventListener("astro:after-swap", init);
  document.addEventListener("astro:before-swap", cleanup);
</script>

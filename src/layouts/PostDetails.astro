---
import { render, type CollectionEntry } from "astro:content";
import { SITE, FEATURES } from "@/config";
import { getI18n } from "@/i18n";
import {
  resolveOgImageUrl,
  getAdjacentPosts,
  getReadingTimeDisplay,
} from "@/utils/post";

// Components
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import PostHero from "@/components/post/PostHero.astro";
import PostContent from "@/components/post/PostContent.astro";
import PostFooter from "@/components/post/PostFooter.astro";
import TableOfContents from "@/components/post/TableOfContents.astro";
import MobileTableOfContents from "@/components/post/MobileTableOfContents.astro";
// Comments component is now imported inside PostFooter

// PERFORMANCE FIX: Import CSS directly to bundle it.
// This eliminates the network chain and prevents layout shifts.
import "katex/dist/katex.min.css";

export interface Props {
  post: CollectionEntry<"blog">;
  posts: CollectionEntry<"blog">[];
}

const { post, posts } = Astro.props;
const {
  title,
  author,
  description,
  ogImage: initOgImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  timezone,
  tags,
  hideEditPost,
} = post.data;
const { Content, headings } = await render(post);

// 1. Data Preparation
const { t, tTag } = getI18n(Astro.currentLocale as "en" | "ka" | undefined);
const readingTimeText = getReadingTimeDisplay(post.body || "");
const ogImage = resolveOgImageUrl(initOgImage, post.slug, Astro.url.origin);
const { previous: prevPost, next: nextPost } = getAdjacentPosts(posts, post.id);

// 2. Config & Helpers
const editPostConfig = FEATURES.editPost;
const showEditPost = !!(
  editPostConfig.enabled &&
  !hideEditPost &&
  editPostConfig.url
);
const currentYear = new Date().getFullYear();
const copyrightText = `Copyright © ${currentYear} • ${t("footer.copyright")}`;
---

<Layout
  title={`${title} | ${SITE.title}`}
  author={author}
  description={description}
  pubDatetime={pubDatetime}
  modDatetime={modDatetime}
  canonicalURL={canonicalURL}
  ogImage={ogImage}
  scrollSmooth
>
  <!-- 
    PERFORMANCE FIX: 
    Removed manual <link> tag for KaTeX. 
    The styles are now bundled in the critical CSS.
  -->

  <Header />

  <!-- 
    LAYOUT REFACTOR: 
    Changed from centered max-w-3xl to a wider max-w-6xl container 
    to accommodate the sidebar without squishing the content.
    Mobile: Simplified margins (mt-6) for quick content access
    Desktop: Activated Flexbox and wider margins (mt-12) on lg screens
  -->
  <div
    class="mx-auto mt-6 w-full max-w-6xl px-4 lg:mt-12 lg:flex lg:items-start lg:gap-12"
  >
    <!-- LEFT RAIL: Table of Contents (Sticky) - Desktop Only -->
    <aside
      class="order-1 hidden lg:sticky lg:top-28 lg:block lg:w-64 lg:shrink-0"
      aria-hidden="true"
    >
      <TableOfContents {headings} />
    </aside>

    <!-- MAIN CONTENT COLUMN -->
    <!-- Added min-w-0 to prevent flex child overflow issues -->
    <main
      id="main-content"
      class="order-2 mx-auto w-full max-w-3xl min-w-0 flex-1 lg:mx-0"
      data-pagefind-body
    >
      <PostHero
        {title}
        {pubDatetime}
        {modDatetime}
        {timezone}
        {readingTimeText}
      />

      <!-- MOBILE TOC: Collapsible, only visible on screens smaller than lg -->
      <MobileTableOfContents {headings} />

      <PostContent>
        <Content />
      </PostContent>

      <PostFooter
        {tags}
        {showEditPost}
        {editPostConfig}
        {post}
        {prevPost}
        {nextPost}
        {tTag}
        locale={Astro.currentLocale}
      />
    </main>
  </div>

  <Footer {copyrightText} />
</Layout>

<script>
  import { featureManager } from "@/utils/features/FeatureManager";

  // Lifecycle Event Manager
  const init = () => {
    featureManager.initializeFeatures();
    // Reset scroll only on navigation, logic handled by listener type
    if (document.documentElement.scrollTop > 0)
      window.scrollTo({ left: 0, top: 0, behavior: "instant" });
  };

  const cleanup = () => featureManager.cleanupFeatures();

  document.addEventListener("astro:page-load", () =>
    featureManager.initializeFeatures()
  );
  document.addEventListener("astro:after-swap", init);
  document.addEventListener("astro:before-swap", cleanup);
</script>

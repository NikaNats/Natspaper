---
import type { GetStaticPaths } from "astro";
import { getLastPathSegment } from "@/utils/core/slugify";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import PostSummaryCard from "@/components/post/PostSummaryCard.astro";
import Pagination from "@/components/ui/Pagination.astro";
import { PostRepository } from "@/utils/post/repository";
import { SITE, FEATURES } from "@/config";
import { SUPPORTED_LANGS, DEFAULT_LANG } from "@/i18n/config";
import type { Lang } from "@/i18n";

export const getStaticPaths = (async ({ paginate }) => {
  const paths = [];

  // Generate paths for all supported locales
  for (const locale of SUPPORTED_LANGS) {
    const postsWithFallback =
      await PostRepository.getByLocaleWithFallback(locale);
    const posts = postsWithFallback.map(p => ({
      ...p.post,
      isFallback: p.isFallback,
      originalLocale: p.originalLocale,
    }));
    // Pass locale as params to paginate so it's included in all paginated routes
    const paginatedPages = paginate(posts, {
      params: { locale },
      pageSize: FEATURES.postPerPage,
    });

    // Each paginated page already has locale in params
    paths.push(...paginatedPages);
  }

  return paths;
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const locale = (Astro.params.locale as Lang) || DEFAULT_LANG;

// Localized content
const pageContentByLocale: Record<
  Lang,
  { title: string; pageTitle: string; pageDesc: string }
> = {
  en: {
    title: `Posts | ${SITE.title}`,
    pageTitle: "Posts",
    pageDesc: "All the articles I've posted.",
  },
  ka: {
    title: `პოსტები | ${SITE.title}`,
    pageTitle: "პოსტები",
    pageDesc: "ყველა სტატია რომელიც მე დავაპოსტე.",
  },
};

const pageContent = pageContentByLocale[locale];
---

<Layout title={pageContent.title}>
  <Header />
  <Main
    pageTitle={pageContent.pageTitle}
    pageDesc={pageContent.pageDesc}
    width="wide"
  >
    {
      /* 
      Responsive Post Grid:
      - Mobile (default): Single column stack for optimal readability
      - Tablet (md+): Still single column for article previews
      - Ultra-wide (3xl+): 2 columns to utilize horizontal space
      - 4K (4xl+): 3 columns for maximum screen real estate
    */
    }
    <ul class="3xl:grid-cols-2 3xl:gap-8 4xl:grid-cols-3 grid gap-6">
      {
        page.data.map(item => {
          // Calculate word count for reading time
          const wordCount = item.body?.split(/\s+/).length || 0;
          return (
            <PostSummaryCard
              title={item.data.title}
              description={item.data.description}
              pubDatetime={item.data.pubDatetime}
              modDatetime={item.data.modDatetime}
              timezone={item.data.timezone}
              slug={getLastPathSegment(item.slug)}
              wordCount={wordCount}
              tags={item.data.tags}
              featured={item.data.featured}
              isFallback={item.isFallback}
              originalLocale={item.originalLocale}
            />
          );
        })
      }
    </ul>
  </Main>

  <Pagination
    currentPage={page.currentPage}
    totalPages={page.lastPage}
    prevUrl={page.url.prev}
    nextUrl={page.url.next}
  />

  <Footer noMarginTop={page.lastPage > 1} />
</Layout>

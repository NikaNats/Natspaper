---
import { type CollectionEntry } from "astro:content";
import { getLastPathSegment } from "@/utils/core/slugify";
import PostDetails from "@/layouts/PostDetails.astro";
import { SUPPORTED_LANGS, DEFAULT_LANG } from "@/i18n/config";
import type { Lang } from "@/i18n";

export interface Props {
  post: CollectionEntry<"blog">;
  isFallback?: boolean;
  originalLocale?: Lang;
}

export async function getStaticPaths() {
  const { PostRepository } = await import("@/utils/post/repository");

  const postResult: Array<{
    params: { locale: string; slug: string };
    props: Props;
  }> = [];

  for (const locale of SUPPORTED_LANGS) {
    const postsWithFallback = await PostRepository.getByLocaleWithFallback(
      locale as Lang
    );

    for (const { post, isFallback, originalLocale } of postsWithFallback) {
      postResult.push({
        params: { locale, slug: getLastPathSegment(post.slug) },
        props: { post, isFallback, originalLocale },
      });
    }
  }

  return postResult;
}

const { post, isFallback, originalLocale } = Astro.props;
const locale = (Astro.params.locale as Lang) || DEFAULT_LANG;

// Use fallback logic for sorted posts to maintain consistency
const sortedPostsWithFallback = await (
  await import("@/utils/post/repository")
).PostRepository.getByLocaleWithFallback(locale);

const sortedPosts = sortedPostsWithFallback.map(p => p.post);
---

<PostDetails
  post={post}
  posts={sortedPosts}
  isFallback={isFallback}
  originalLocale={originalLocale}
/>

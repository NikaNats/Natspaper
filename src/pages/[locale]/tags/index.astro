---
import type { GetStaticPaths } from "astro";
import { PostRepository } from "@/utils/post/repository";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import { getUniqueTags, getPostsByTag } from "@/utils/post";
import { SITE } from "@/config";
import { SUPPORTED_LANGS, DEFAULT_LANG } from "@/i18n/config";
import type { Lang } from "@/i18n";

export const getStaticPaths = (() => {
  return SUPPORTED_LANGS.map(locale => ({
    params: { locale },
  }));
}) satisfies GetStaticPaths;

// Extract and validate locale from URL params
const locale = (
  SUPPORTED_LANGS.includes(Astro.params.locale as Lang)
    ? Astro.params.locale
    : DEFAULT_LANG
) as Lang;

const posts = await PostRepository.getByLocale(locale);

const tags = getUniqueTags(posts, locale)
  .map(tagItem => {
    const count = getPostsByTag(posts, tagItem.tag).length;
    return {
      ...tagItem,
      count,
    };
  })
  .sort((a, b) => b.count - a.count);

// Page content localized by language
const pageContentByLocale: Record<
  Lang,
  {
    title: string;
    pageTitle: string;
    pageDesc: string;
    ariaLabelTemplate: (count: number, tagName: string) => string;
  }
> = {
  en: {
    title: `Tags | ${SITE.title}`,
    pageTitle: "Topics",
    pageDesc: "Browse articles by subject matter and category.",
    ariaLabelTemplate: (count, tagName) =>
      `View ${count} posts tagged with ${tagName}`,
  },
  ka: {
    title: `თეგები | ${SITE.title}`,
    pageTitle: "თემები",
    pageDesc: "იხილეთ სტატიები თემებისა და კატეგორიების მიხედვით.",
    ariaLabelTemplate: (count, tagName) => `${tagName}: ${count} სტატია`,
  },
};

const pageContent = pageContentByLocale[locale];
---

<Layout title={pageContent.title}>
  <Header />
  <Main pageTitle={pageContent.pageTitle} pageDesc={pageContent.pageDesc}>
    <ul class="mx-auto mt-8 flex max-w-3xl flex-wrap gap-3">
      {
        tags.map(({ tag, tagName, count }) => (
          <li>
            <a
              href={`/${locale}/tags/${tag}/`}
              transition:name={`tag-${tag}`}
              aria-label={pageContent.ariaLabelTemplate(count, tagName)}
              class="group flex items-center justify-between gap-3 rounded-full border border-transparent bg-muted px-5 py-3 text-base whitespace-nowrap no-underline transition-all duration-300 hover:scale-105 hover:border-accent hover:bg-accent/10"
            >
              <span class="font-medium text-foreground transition-colors group-hover:text-accent">
                <span class="mr-0.5 text-accent/50" aria-hidden="true">
                  #
                </span>
                {tagName}
              </span>

              <span
                aria-hidden="true"
                class="flex h-5 min-w-5 translate-y-0.5 items-center justify-center rounded-full border border-border bg-background px-1.5 font-mono text-xs leading-none text-text-secondary transition-colors group-hover:border-accent/30 group-hover:text-accent"
              >
                {count}
              </span>
            </a>
          </li>
        ))
      }
    </ul>
  </Main>
  <Footer />
</Layout>

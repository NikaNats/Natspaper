---
import { contentRepo } from "@/utils/content.repository";
import { getLastPathSegment } from "@/utils/core/slugify";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import PostSummaryCard from "@/components/post/PostSummaryCard.astro";
import getPostsByGroupCondition from "@/utils/post/getPostsByGroupCondition";
import { SITE } from "@/config";

// Redirect to 404 page if `showArchives` config is false
if (!SITE.showArchives) {
  return Astro.redirect("/ka/404");
}

const posts = await contentRepo.getPostsByLocale("ka");

const months = [
  "იანვარი",
  "თებერვალი",
  "მარტი",
  "აპრილი",
  "მაისი",
  "ივნისი",
  "ივლისი",
  "აგვისტო",
  "სექტემბერი",
  "ოქტომბერი",
  "ნოემბერი",
  "დეკემბერი",
];
---

<Layout title={`არქივი | ${SITE.title}`}>
  <Header />
  <Main pageTitle="არქივი" pageDesc="ყველა სტატია რომელიც მე დავამარხე.">
    <div class="mt-8 space-y-12">
      {
        Object.entries(
          getPostsByGroupCondition(posts, post =>
            post.data.pubDatetime.getFullYear()
          )
        )
          .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
          .map(([year, yearGroup]) => (
            <div class="relative border-l-2 border-dashed border-border/50 pt-2 pl-8">
              {/* Year Label (Sticky or absolute for style) */}
              <span class="absolute top-2 -left-[9px] h-4 w-4 rounded-full border-4 border-background bg-accent" />

              <h3 class="mb-8 flex items-center gap-2 text-3xl font-bold text-foreground">
                {year}
                <span class="rounded-full bg-muted px-2 py-1 text-xs font-medium text-text-secondary">
                  {yearGroup.length}
                </span>
              </h3>

              <div class="space-y-8">
                {Object.entries(
                  getPostsByGroupCondition(
                    yearGroup,
                    post => post.data.pubDatetime.getMonth() + 1
                  )
                )
                  .sort(([monthA], [monthB]) => Number(monthB) - Number(monthA))
                  .map(([month, monthGroup]) => (
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-[100px_1fr] sm:gap-8">
                      {/* Month Label */}
                      <div class="flex flex-row items-baseline gap-2 text-lg sm:flex-col sm:items-end sm:gap-0 sm:text-right">
                        <span class="font-bold text-text-secondary">
                          {months[Number(month) - 1]}
                        </span>
                        <span class="text-xs text-text-secondary/60">
                          {monthGroup.length} პოსტი
                        </span>
                      </div>

                      <ul class="space-y-4">
                        {monthGroup
                          .sort(
                            (a, b) =>
                              Math.floor(
                                new Date(b.data.pubDatetime).getTime() / 1000
                              ) -
                              Math.floor(
                                new Date(a.data.pubDatetime).getTime() / 1000
                              )
                          )
                          .map(({ data, slug, body }) => {
                            const wordCount = body.split(/\s+/).length;

                            return (
                              <PostSummaryCard
                                title={data.title}
                                description={data.description}
                                pubDatetime={data.pubDatetime}
                                modDatetime={null}
                                timezone={data.timezone}
                                slug={getLastPathSegment(slug)}
                                wordCount={wordCount}
                              />
                            );
                          })}
                      </ul>
                    </div>
                  ))}
              </div>
            </div>
          ))
      }
    </div>
  </Main>
  <Footer />
</Layout>

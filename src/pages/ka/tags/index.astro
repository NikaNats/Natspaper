---
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import { getUniqueTags, getPostsByTag } from "@/utils/post";
import { SITE } from "@/config";

import { contentRepo } from "@/utils/content.repository";
const posts = await contentRepo.getPostsByLocale("ka");

// 1. Get tags and calculate counts
// We map over the unique tags and use your existing utility to find the count
const tags = getUniqueTags(posts, Astro.currentLocale as "en" | "ka").map(tagItem => {
  const count = getPostsByTag(posts, tagItem.tag).length;
  return {
    ...tagItem,
    count
  };
}).sort((a, b) => b.count - a.count); // Sort by popularity (descending)
---

<Layout title={`თეგები | ${SITE.title}`}>
  <Header />
  <Main
    pageTitle="თემები"
    pageDesc="სტატიების დათვალიერება თემისა და კატეგორიის მიხედვით."
  >
    <!-- 2. The Taxonomy Cloud -->
    <!-- max-w-3xl ensures the cloud doesn't get too wide and hard to read -->
    <ul class="flex flex-wrap gap-3 mx-auto max-w-3xl mt-8">
      {tags.map(({ tag, tagName, count }) => (
        <li>
          <a
            href={`/${Astro.currentLocale}/tags/${tag}/`}
            transition:name={tag}
            class="group flex items-center justify-between gap-3 px-5 py-3 text-base border border-border/50 bg-muted/10 rounded-full hover:border-accent hover:bg-accent/5 hover:scale-105 transition-all duration-300 no-underline"
          >
            <span class="font-medium text-foreground group-hover:text-accent transition-colors">
              <span class="text-accent/50 mr-0.5">#</span>{tagName}
            </span>
            
            {/* The Counter Badge */}
            <span class="flex items-center justify-center h-5 min-w-5 px-1.5 text-xs font-mono text-text-secondary bg-background border border-border rounded-full group-hover:border-accent/30 group-hover:text-accent transition-colors">
              {count}
            </span>
          </a>
        </li>
      ))}
    </ul>
  </Main>
  <Footer />
</Layout>

/* src/styles/typography.css */
@plugin "@tailwindcss/typography";

@layer base {
  /* Main Prose Wrapper */
  .app-prose {
    @apply prose prose-neutral dark:prose-invert;
    @apply text-foreground marker:text-accent;
    font-family: var(--font-inter), sans-serif;

    /* 
     * Optimal line-height: 1.6 for body text
     * Research: 1.5-1.6 is ideal for fonts with high x-height (Inter)
     * Previous: 1.7 was too airy, disconnecting lines visually
     */
    line-height: 1.6;

    /* 
     * Slightly positive letter-spacing improves body text legibility
     * 0.01em provides subtle openness without affecting rhythm
     */
    letter-spacing: 0.01em;

    /**
     * Optimal reading width: 65ch (50-75 characters per line)
     * This provides the ideal measure for comfortable reading
     * Centered within parent container via margin auto
     */
    max-width: 65ch;
    margin-inline: auto;
    width: 100%;

    /**
     * Fluid Heading Typography
     * ========================
     * Using clamp() for smooth scaling from 320px to 4K (2560px).
     * Formula: clamp(min, preferred, max)
     * - min: Smallest readable size on mobile
     * - preferred: Fluid scaling based on viewport
     * - max: Largest size to prevent oversized headings on 4K
     */
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    th {
      @apply relative scroll-mt-20 font-bold text-foreground;
      letter-spacing: -0.02em;
      line-height: 1.2;
      text-wrap: balance; /* Modern CSS for better heading line breaks */
    }
    h1 {
      @apply mb-6;
      /* Scales: 1.75rem (28px) → 3rem (48px) based on viewport */
      font-size: clamp(1.75rem, 1.25rem + 2.5vw, 3rem);
      /* -0.025em is optimal for large headings: tight but not cramped */
      letter-spacing: -0.025em;
    }
    h2 {
      @apply mt-10 mb-5;
      /* Scales: 1.5rem (24px) → 2.25rem (36px) */
      font-size: clamp(1.5rem, 1.15rem + 1.75vw, 2.25rem);
    }
    h3 {
      @apply mt-8 mb-4;
      /* Scales: 1.25rem (20px) → 1.875rem (30px) */
      font-size: clamp(1.25rem, 1rem + 1.25vw, 1.875rem);
    }
    h4 {
      @apply mt-6 mb-3;
      /* Scales: 1.125rem (18px) → 1.5rem (24px) */
      font-size: clamp(1.125rem, 0.95rem + 0.875vw, 1.5rem);
    }
    h5 {
      @apply mt-5 mb-2;
      /* Scales: 1rem (16px) → 1.25rem (20px) */
      font-size: clamp(1rem, 0.9rem + 0.5vw, 1.25rem);
    }
    h6 {
      @apply mt-4 mb-2;
      /* Scales: 0.875rem (14px) → 1.125rem (18px) */
      font-size: clamp(0.875rem, 0.8rem + 0.375vw, 1.125rem);
    }

    /* Content */
    p {
      @apply mb-5 font-normal;
    }
    strong {
      @apply font-semibold text-foreground;
    }

    a {
      @apply wrap-break-word text-accent decoration-dashed underline-offset-4 transition-colors hover:text-accent/80 focus-visible:rounded-sm focus-visible:outline-accent;
    }

    ul,
    ol {
      @apply my-6 list-outside;
    }
    li {
      @apply pl-1.5;
    }

    /* Tables */
    table {
      /* 
       * 1. LAYOUT TRANSFORMATION
       * Change from 'table' to 'block' to allow the container 
       * to respect the parent's width constraints.
       */
      display: block;

      /* 
       * 2. SCROLL CONTAINMENT
       * If content exceeds width, show scrollbar on the TABLE only,
       * not the whole page.
       */
      overflow-x: auto;

      /* 
       * 3. UX OPTIMIZATION
       * Prevent text from wrapping aggressively. This ensures the table
       * keeps its shape and encourages the user to scroll, rather than
       * seeing a tall, squashed table.
       */
      white-space: nowrap;

      /* 
       * 4. IOS NATIVE FEEL
       * Enables momentum/inertial scrolling on iPhones/iPads.
       * Without this, scrolling feels "sticky" and broken.
       */
      -webkit-overflow-scrolling: touch;

      /* 
       * 5. VISUAL RESET
       * Ensure the block fills the available space.
       */
      width: 100%;
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
      border-collapse: collapse;
      text-align: left;

      /* 
       * 6. MOBILE BLEED INTEGRATION (Your Existing Logic)
       * This logic now works safely because overflow-x handles the excess width.
       */
      @media (max-width: 640px) {
        --bleed-margin: calc(var(--layout-padding-fluid, 1rem) * -1);

        margin-left: var(--bleed-margin);
        margin-right: var(--bleed-margin);

        /* Recalculate width to account for the negative margins */
        width: calc(100% + var(--layout-padding-fluid, 1rem) * 2);

        border-radius: 0;
        border-left: none;
        border-right: none;
      }
    }

    table th,
    table td {
      @apply border border-border p-3 align-top;
    }
    table th {
      @apply bg-muted/30 font-semibold;
    }

    blockquote {
      @apply my-6 border-l-4 border-accent/40 pl-4 italic opacity-90;
    }

    /* ==========================================================================
       FLUID CONTENT ASSETS
       ==========================================================================
       Responsive media elements with:
       - Fluid sizing that respects container width
       - Aspect ratio preservation
       - Lazy loading optimization
       - GPU-accelerated transitions
       - Accessible loading states
       ========================================================================== */

    /* Figure Container - Semantic wrapper for media */
    figure {
      @apply mx-0 my-8;

      /* Fluid vertical spacing */
      margin-block: clamp(1.5rem, 1rem + 2vw, 3rem);
    }

    /* Images - Fluid responsive sizing */
    img {
      /* Fluid sizing - fills container but respects aspect ratio */
      width: 100%;
      height: auto;
      max-width: 100%;

      /* Visual polish */
      border-radius: clamp(0.5rem, 0.25rem + 0.5vw, 1rem);
      background-color: var(--muted);

      /* Smooth loading transition */
      opacity: 1;
      transition:
        opacity 0.3s ease,
        transform 0.3s ease,
        box-shadow 0.3s ease;

      /* Subtle depth */
      box-shadow:
        0 4px 6px -1px rgb(0 0 0 / 0.1),
        0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    /* Loading state for lazy-loaded images */
    img[loading="lazy"] {
      /* Placeholder background while loading */
      background: linear-gradient(
        90deg,
        var(--muted) 0%,
        var(--border) 50%,
        var(--muted) 100%
      );
      background-size: 200% 100%;
    }

    /* Hover effect for clickable images (in links) */
    a img {
      &:hover {
        transform: scale(1.01);
        box-shadow:
          0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
      }
    }

    /* Figure Caption - Fluid typography */
    figcaption {
      @apply text-center italic;

      /* Fluid sizing: 0.8125rem (13px) → 0.9375rem (15px) */
      font-size: clamp(0.8125rem, 0.75rem + 0.125vw, 0.9375rem);
      line-height: 1.5;
      color: var(--text-secondary);

      /* Fluid spacing */
      margin-block-start: clamp(0.5rem, 0.375rem + 0.25vw, 0.75rem);
      padding-inline: clamp(0.5rem, 0.25rem + 0.5vw, 1rem);
    }

    /* Video Elements - Fluid responsive */
    video {
      width: 100%;
      height: auto;
      max-width: 100%;
      border-radius: clamp(0.5rem, 0.25rem + 0.5vw, 1rem);
      background-color: var(--muted);

      /* Fluid vertical spacing */
      margin-block: clamp(1.5rem, 1rem + 2vw, 3rem);
    }

    /* Iframe Embeds (YouTube, CodePen, etc.) - Responsive container */
    iframe {
      width: 100%;
      max-width: 100%;
      border: none;
      border-radius: clamp(0.5rem, 0.25rem + 0.5vw, 1rem);
      background-color: var(--muted);

      /* Default 16:9 aspect ratio for video embeds */
      aspect-ratio: 16 / 9;

      /* Fluid vertical spacing */
      margin-block: clamp(1.5rem, 1rem + 2vw, 3rem);
    }

    /* Audio Elements */
    audio {
      width: 100%;
      max-width: 100%;

      /* Fluid vertical spacing */
      margin-block: clamp(1rem, 0.75rem + 0.5vw, 1.5rem);
    }

    /* SVG Images - Fluid sizing */
    svg:not(.icon) {
      width: 100%;
      height: auto;
      max-width: 100%;
    }

    /* Picture Element - For art direction */
    picture {
      display: block;
      width: 100%;

      img {
        display: block;
      }
    }

    /* Object/Embed Elements */
    object,
    embed {
      width: 100%;
      max-width: 100%;
    }

    /* Code */
    :not(pre) > code {
      @apply rounded bg-muted px-1.5 py-0.5 text-[0.9em] text-foreground before:hidden after:hidden;
      font-family: var(--font-jetbrains-mono), monospace;
    }
    pre {
      @apply my-6 overflow-x-auto rounded-lg border border-border p-4;
      font-family: var(--font-jetbrains-mono), monospace;
    }

    /* Math */
    .katex,
    .katex-display {
      @apply text-foreground;
    }

    /* 
      MOBILE OPTIMIZATIONS 
      These rules allow "bleeding" content to the edge on mobile screens (<640px)
      to maximize usage of the limited horizontal space for complex elements.
      Note: Heading sizes now use clamp() for fluid scaling, so no font-size overrides needed.
    */
    @media (max-width: 640px) {
      /* Tighter spacing on mobile */
      h1 {
        @apply mb-4;
      }
      h2 {
        @apply mt-8 mb-4;
      }
      h3 {
        @apply mt-6 mb-3;
      }
      h4 {
        @apply mt-4 mb-2;
      }

      /* 
        Bleed Effect:
        Uses fluid padding variable to calculate proper negative margin.
        This ensures bleed works correctly across all viewport sizes.
      */
      figure,
      .astro-code,
      pre {
        --bleed-margin: calc(var(--layout-padding-fluid, 1rem) * -1);
        margin-inline: var(--bleed-margin);
        width: calc(100% + var(--layout-padding-fluid, 1rem) * 2);
        @apply rounded-none border-x-0;
      }

      /* Full-bleed images on mobile */
      img {
        border-radius: 0;
        box-shadow: none;
      }

      /* Full-bleed videos and iframes on mobile */
      video,
      iframe {
        --bleed-margin: calc(var(--layout-padding-fluid, 1rem) * -1);
        margin-inline: var(--bleed-margin);
        width: calc(100% + var(--layout-padding-fluid, 1rem) * 2);
        border-radius: 0;
      }

      /* Compact figure captions on mobile */
      figcaption {
        padding-inline: 0;
        font-size: 0.8125rem;
      }
    }

    /* ==========================================================================
       REDUCED MOTION
       ========================================================================== */
    @media (prefers-reduced-motion: reduce) {
      img,
      video {
        transition: none;
      }

      a img:hover {
        transform: none;
      }
    }
  }

  .main-heading {
    @apply leading-tight font-bold;
    font-family: var(--font-inter), sans-serif;
    /**
     * Enhanced Fluid Typography for Main Headings
     * ============================================
     * Scales smoothly from 320px mobile to 4K (2560px+)
     * min: 1.75rem (28px) - Readable on smallest screens
     * max: 4rem (64px) - Impactful on 4K without overwhelming
     * preferred: 1.25rem + 3.5vw - Smooth transition curve
     */
    font-size: clamp(1.75rem, 1.25rem + 3.5vw, 4rem);
    /* -0.025em is optimal for large headings: tight but not cramped */
    letter-spacing: -0.025em;
    text-wrap: balance;
  }

  /**
   * Utility Classes for Fixed Width Typography
   * ============================================
   * Use these to ensure consistent readable line lengths
   */
  .readable-width {
    max-width: var(--main-width, 720px);
    width: 100%;
  }

  .wide-readable-width {
    max-width: 840px;
    width: 100%;
  }
}
